<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>TBM Anak Bangsa - Kab. Kepulauan Anambas</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Plus+Jakarta+Sans:wght@400;500;600;700;800&display=swap" rel="stylesheet">
    <style>
        body { 
            font-family: 'Plus Jakarta Sans', sans-serif; 
            background-color: #f1f5f9; 
            -webkit-tap-highlight-color: transparent; 
        }
        
        /* Animations */
        .fade-in { animation: fadeIn 0.4s ease-out forwards; opacity: 0; transform: translateY(10px); }
        @keyframes fadeIn { to { opacity: 1; transform: translateY(0); } }
        
        /* Custom Scrollbar */
        .custom-scrollbar::-webkit-scrollbar { width: 6px; height: 6px; }
        .custom-scrollbar::-webkit-scrollbar-track { background: transparent; }
        .custom-scrollbar::-webkit-scrollbar-thumb { background: #cbd5e1; border-radius: 10px; }
        .custom-scrollbar::-webkit-scrollbar-thumb:hover { background: #94a3b8; }

        /* Visual Elements */
        .curved-header { 
            background: linear-gradient(135deg, #059669 0%, #047857 100%); 
            border-bottom-left-radius: 40px; 
            border-bottom-right-radius: 40px; 
            padding-bottom: 80px; 
            box-shadow: 0 20px 40px -10px rgba(5, 150, 105, 0.3); 
            position: relative;
            overflow: hidden;
        }
        
        .curved-header::before {
            content: '';
            position: absolute;
            top: -50%;
            left: -50%;
            width: 200%;
            height: 200%;
            background: radial-gradient(circle, rgba(255,255,255,0.1) 0%, transparent 60%);
            pointer-events: none;
        }

        .input-field { 
            width: 100%; padding: 12px 16px; border-radius: 12px; 
            border: 1px solid #e2e8f0; background: #f8fafc; 
            outline: none; transition: all 0.2s; font-size: 14px; 
            color: #334155;
        }
        .input-field:focus { 
            border-color: #059669; background: white; 
            box-shadow: 0 0 0 3px rgba(16, 185, 129, 0.1); 
        }

        /* Charts CSS */
        .donut-chart { 
            position: relative; width: 80px; height: 80px; border-radius: 50%; 
            background: conic-gradient(var(--color) var(--percent), #e2e8f0 0); 
            display: flex; align-items: center; justify-content: center; 
            transition: all 0.5s ease;
        }
        .donut-inner { 
            width: 64px; height: 64px; background: white; border-radius: 50%; 
            display: flex; flex-direction: column; align-items: center; 
            justify-content: center; font-weight: 800; font-size: 16px; color: #334155; 
            box-shadow: inset 0 2px 4px rgba(0,0,0,0.05);
        }

        /* PRINT STYLES */
        @media print { 
            body * { visibility: hidden; }
            #printArea, #printArea * { 
                visibility: visible !important; 
                display: block !important;
            }
            #printArea { 
                position: absolute; 
                left: 0; top: 0; width: 100%; margin: 0; padding: 0;
                background: white; 
                z-index: 9999;
            }
            @page { margin: 0.5cm; size: auto; }
            * { -webkit-print-color-adjust: exact !important; print-color-adjust: exact !important; } 
        }
    </style>
</head>
<body class="text-slate-800 min-h-screen flex flex-col bg-slate-100 overflow-x-hidden">

    <!-- MAIN APP CONTAINER -->
    <div id="app" class="flex-1 flex flex-col w-full mx-auto relative"></div>

    <!-- MODAL COMPONENT -->
    <div id="modalOverlay" class="fixed inset-0 bg-slate-900/70 backdrop-blur-sm hidden items-center justify-center z-50 p-4 transition-opacity duration-300">
        <div class="bg-white w-full max-w-lg rounded-3xl shadow-2xl overflow-hidden transform transition-all scale-100 flex flex-col max-h-[90vh] fade-in">
            <div class="p-5 border-b border-slate-100 flex justify-between items-center bg-white sticky top-0 z-10">
                <h3 id="modalTitle" class="font-bold text-xl text-slate-800 tracking-tight">Judul Modal</h3>
                <button onclick="closeModal()" class="w-8 h-8 rounded-full bg-slate-50 text-slate-400 flex items-center justify-center hover:bg-red-50 hover:text-red-500 transition font-bold text-lg">&times;</button>
            </div>
            <div id="modalContent" class="p-6 overflow-y-auto custom-scrollbar bg-white"></div>
        </div>
    </div>

    <!-- PRINT AREA -->
    <div id="printArea" class="hidden bg-white text-black"></div>

    <script>
        /**
         * ------------------------------------------------------------------
         * CONFIG & STATE
         * ------------------------------------------------------------------
         */
        const DEFAULT_DATA = {
            books: [
                { id: 1, title: "Laskar Pelangi", author: "Andrea Hirata", isbn: "978-979-3062-79-2", category: "Novel", stock: 5, shelf: "A-01", createdBy: 'admin' },
                { id: 2, title: "Bumi Manusia", author: "Pramoedya A. Toer", isbn: "978-979-97312-3-4", category: "Sastra", stock: 3, shelf: "A-02", createdBy: 'admin' },
                { id: 3, title: "Atomic Habits", author: "James Clear", isbn: "978-073-5211-29-2", category: "Self-Help", stock: 4, shelf: "B-01", createdBy: 'admin' },
                { id: 4, title: "Filosofi Teras", author: "Henry Manampiring", isbn: "978-602-412-518-9", category: "Filsafat", stock: 7, shelf: "B-02", createdBy: 'admin' }
            ],
            members: [
                { id: "AGT-2024001", name: "Siti Aisyah", type: "Pelajar", nik: "1234567890", gender: "P", birthPlace: "Tarempa", birthDate: "2005-05-12", phone: "08123456789", address: "Jl. Hang Tuah No. 5", photo: null, active: true, createdBy: 'admin', joinDate: '2024-01-15' },
                { id: "AGT-2024002", name: "Budi Santoso", type: "Umum", nik: "0987654321", gender: "L", birthPlace: "Letung", birthDate: "1995-08-20", phone: "08987654321", address: "Jl. Imam Bonjol No. 88", photo: null, active: true, createdBy: 'admin', joinDate: '2024-02-01' }
            ],
            loans: [],
            visitors: [],
            users: [{ id: 'admin', name: "Administrator", role: "admin", password: "admin", active: true }]
        };

        // Init State
        let books = JSON.parse(localStorage.getItem('tbm_books')) || DEFAULT_DATA.books;
        let members = JSON.parse(localStorage.getItem('tbm_members')) || DEFAULT_DATA.members;
        let loans = JSON.parse(localStorage.getItem('tbm_loans')) || DEFAULT_DATA.loans;
        let visitors = JSON.parse(localStorage.getItem('tbm_visitors')) || DEFAULT_DATA.visitors;
        let users = JSON.parse(localStorage.getItem('tbm_users')) || DEFAULT_DATA.users;

        let currentView = 'visitor'; 
        let adminTab = 'dashboard'; 
        let currentUser = null; 
        let editId = null; 
        let editUserId = null; 
        let photoPreview = null;
        let filterStart = '', filterEnd = '', searchTerm = '', printSearch = '', catalogSearch = '';

        /**
         * ------------------------------------------------------------------
         * CORE UTILITIES
         * ------------------------------------------------------------------
         */
        function saveData() {
            localStorage.setItem('tbm_books', JSON.stringify(books));
            localStorage.setItem('tbm_members', JSON.stringify(members));
            localStorage.setItem('tbm_loans', JSON.stringify(loans));
            localStorage.setItem('tbm_visitors', JSON.stringify(visitors));
            localStorage.setItem('tbm_users', JSON.stringify(users));
            render();
        }

        function setView(v) { 
            currentView = v; 
            if(v === 'visitor') currentUser = null; 
            render(); 
        }

        function setTab(t) { 
            adminTab = t; 
            filterStart = ''; filterEnd = ''; searchTerm = ''; printSearch = ''; 
            render(); 
        }

        function login(u, p) { 
            const user = users.find(x => x.name.toLowerCase() === u.toLowerCase() && x.password === p && x.active); 
            if(user) { 
                currentUser = user; 
                closeModal(); 
                setView('admin'); 
                setTab('dashboard'); 
            } else {
                alert("Login Gagal! Username atau password salah."); 
            }
        }

        function canEdit(item) { 
            if(!currentUser) return false; 
            if(currentUser.role === 'admin') return true; 
            return item.createdBy === currentUser.id; 
        }

        /**
         * ------------------------------------------------------------------
         * RENDER ENGINE
         * ------------------------------------------------------------------
         */
        function render() { 
            const app = document.getElementById('app'); 
            if(currentView === 'visitor') renderVisitor(app); 
            else renderAdmin(app); 
        }

        // --- VISITOR VIEW ---
        function renderVisitor(container) {
            const tb = books.length; 
            const tm = members.filter(m => m.active).length; 
            const today = new Date().toISOString().slice(0,10);
            const tv = visitors.filter(v => v.date === today).length;

            container.innerHTML = `
                <div class="min-h-screen flex justify-center bg-slate-50">
                    <div class="w-full max-w-md bg-white shadow-2xl relative flex flex-col min-h-screen overflow-hidden">
                        <!-- Header -->
                        <div class="curved-header pt-12 px-6 text-center relative">
                            <div class="absolute top-0 left-0 w-full h-full opacity-10 bg-[url('https://www.transparenttextures.com/patterns/cubes.png')]"></div>
                            <div class="bg-white/20 backdrop-blur-md w-20 h-20 mx-auto rounded-2xl flex items-center justify-center mb-4 border border-white/30 shadow-lg">
                                <svg class="w-10 h-10 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 6.253v13m0-13C10.832 5.477 9.246 5 7.5 5S4.168 5.477 3 6.253v13C4.168 18.477 5.754 18 7.5 18s3.332.477 4.5 1.253m0-13C13.168 5.477 14.754 5 16.5 5c1.747 0 3.332.477 4.5 1.253v13C19.832 18.477 18.247 18 16.5 18c-1.746 0-3.332.477-4.5 1.253"/></svg>
                            </div>
                            <!-- NAMA APLIKASI DIUBAH DI SINI -->
                            <h1 class="text-2xl font-extrabold text-white tracking-tight drop-shadow-sm uppercase">TBM Anak Bangsa</h1>
                            <p class="text-emerald-100 text-sm font-medium mt-1 opacity-90">Kabupaten Kepulauan Anambas</p>
                            
                            <button onclick="openLoginModal()" class="absolute top-6 right-6 bg-white/10 hover:bg-white/20 p-2 rounded-xl text-white transition backdrop-blur-md border border-white/20">
                                <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M11 16l-4-4m0 0l4-4m-4 4h14m-5 4v1a3 3 0 01-3 3H6a3 3 0 01-3-3V7a3 3 0 013-3h7a3 3 0 013 3v1"/></svg>
                            </button>
                        </div>

                        <!-- Main Content -->
                        <div class="px-6 -mt-14 relative z-10 space-y-5 fade-in pb-10">
                            <!-- Stats Card -->
                            <div class="bg-white rounded-3xl p-6 shadow-xl border border-slate-100 flex justify-between items-center">
                                <div class="flex flex-col items-center group cursor-pointer">
                                    <div class="donut-chart group-hover:scale-105" style="--color: #3b82f6; --percent: 75%;">
                                        <div class="donut-inner text-blue-600">${tb}</div>
                                    </div>
                                    <span class="text-[11px] font-bold text-slate-400 mt-2 uppercase tracking-wider">Koleksi</span>
                                </div>
                                <div class="w-px h-12 bg-slate-100"></div>
                                <div class="flex flex-col items-center group cursor-pointer">
                                    <div class="donut-chart group-hover:scale-105" style="--color: #a855f7; --percent: 60%;">
                                        <div class="donut-inner text-purple-600">${tm}</div>
                                    </div>
                                    <span class="text-[11px] font-bold text-slate-400 mt-2 uppercase tracking-wider">Anggota</span>
                                </div>
                                <div class="w-px h-12 bg-slate-100"></div>
                                <div class="flex flex-col items-center group cursor-pointer">
                                    <div class="donut-chart group-hover:scale-105" style="--color: #f97316; --percent: ${Math.min(tv*10,100)}%;">
                                        <div class="donut-inner text-orange-600">${tv}</div>
                                    </div>
                                    <span class="text-[11px] font-bold text-slate-400 mt-2 uppercase tracking-wider">Tamu</span>
                                </div>
                            </div>

                            <!-- Menu Buttons -->
                            <button onclick="openVisitorForm()" class="w-full bg-white p-5 rounded-3xl shadow-md border border-slate-50 flex items-center gap-5 hover:shadow-lg hover:border-orange-100 transition-all active:scale-[0.98] group relative overflow-hidden">
                                <div class="absolute inset-0 bg-orange-50 transform -translate-x-full group-hover:translate-x-0 transition-transform duration-500"></div>
                                <div class="w-14 h-14 bg-orange-100 text-orange-600 rounded-2xl flex items-center justify-center shadow-sm relative z-10 group-hover:scale-110 transition-transform">
                                    <svg class="w-7 h-7" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15.232 5.232l3.536 3.536m-2.036-5.036a2.5 2.5 0 113.536 3.536L6.5 21.036H3v-3.572L16.732 3.732z"/></svg>
                                </div>
                                <div class="text-left relative z-10">
                                    <h3 class="font-bold text-xl text-slate-800 group-hover:text-orange-700 transition-colors">Buku Tamu</h3>
                                    <p class="text-slate-500 text-sm">Isi kehadiran pengunjung</p>
                                </div>
                                <div class="ml-auto text-slate-300 relative z-10">
                                    <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7"/></svg>
                                </div>
                            </button>

                            <button onclick="openCatalog()" class="w-full bg-white p-5 rounded-3xl shadow-md border border-slate-50 flex items-center gap-5 hover:shadow-lg hover:border-blue-100 transition-all active:scale-[0.98] group relative overflow-hidden">
                                <div class="absolute inset-0 bg-blue-50 transform -translate-x-full group-hover:translate-x-0 transition-transform duration-500"></div>
                                <div class="w-14 h-14 bg-blue-100 text-blue-600 rounded-2xl flex items-center justify-center shadow-sm relative z-10 group-hover:scale-110 transition-transform">
                                    <svg class="w-7 h-7" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z"/></svg>
                                </div>
                                <div class="text-left relative z-10">
                                    <h3 class="font-bold text-xl text-slate-800 group-hover:text-blue-700 transition-colors">Cari Buku</h3>
                                    <p class="text-slate-500 text-sm">Lihat stok & lokasi buku</p>
                                </div>
                                <div class="ml-auto text-slate-300 relative z-10">
                                    <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7"/></svg>
                                </div>
                            </button>

                            <div class="text-center mt-10">
                                <p class="text-xs text-slate-400 font-medium">¬© 2024 TBM Anak Bangsa</p>
                            </div>
                        </div>
                    </div>
                </div>`;
        }

        // --- ADMIN VIEW ---
        function renderAdmin(container) {
            const isAdmin = currentUser && currentUser.role === 'admin';
            
            let content = `
            <div class="flex min-h-screen bg-slate-100">
                <!-- Sidebar (Desktop) -->
                <div class="hidden md:flex flex-col w-64 bg-slate-900 text-white fixed h-full shadow-2xl z-20">
                    <div class="p-6 border-b border-slate-800 flex flex-col items-center">
                        <div class="w-16 h-16 bg-emerald-500 rounded-2xl flex items-center justify-center text-3xl mb-3 shadow-lg shadow-emerald-500/30">üìö</div>
                        <!-- SIDEBAR TITLE -->
                        <div class="font-bold text-lg tracking-wide text-center leading-tight">TBM Anak Bangsa</div>
                        <div class="text-[10px] text-slate-400 mt-1">Kab. Kepulauan Anambas</div>
                        <div class="text-xs text-emerald-300 mt-2 bg-slate-800 px-3 py-1 rounded-full">${currentUser.role === 'admin' ? 'Administrator' : 'Petugas'}</div>
                    </div>
                    <nav class="flex-1 p-4 space-y-2 overflow-y-auto custom-scrollbar">
                        ${renderSidebar('dashboard','Dashboard', 'M4 6a2 2 0 012-2h2a2 2 0 012 2v2a2 2 0 01-2 2H6a2 2 0 01-2-2V6zM14 6a2 2 0 012-2h2a2 2 0 012 2v2a2 2 0 01-2 2h-2a2 2 0 01-2-2V6zM4 16a2 2 0 012-2h2a2 2 0 012 2v2a2 2 0 01-2 2H6a2 2 0 01-2-2v-2zM14 16a2 2 0 012-2h2a2 2 0 012 2v2a2 2 0 01-2 2h-2a2 2 0 01-2-2v-2z')}
                        ${renderSidebar('anggota','Data Anggota', 'M12 4.354a4 4 0 110 5.292M15 21H3v-1a6 6 0 0112 0v1zm0 0h6v-1a6 6 0 00-9-5.197M13 7a4 4 0 11-8 0 4 4 0 018 0z')}
                        ${renderSidebar('buku','Data Buku', 'M12 6.253v13m0-13C10.832 5.477 9.246 5 7.5 5S4.168 5.477 3 6.253v13C4.168 18.477 5.754 18 7.5 18s3.332.477 4.5 1.253m0-13C13.168 5.477 14.754 5 16.5 5c1.747 0 3.332.477 4.5 1.253v13C19.832 18.477 18.247 18 16.5 18c-1.746 0-3.332.477-4.5 1.253')}
                        ${renderSidebar('peminjaman','Sirkulasi', 'M8 7h12m0 0l-4-4m4 4l-4 4m0 6H4m0 0l4 4m-4-4l4-4')}
                        ${isAdmin ? renderSidebar('laporan','Laporan & Cetak', 'M9 17v-2m3 2v-4m3 4v-6m2 10H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z') : ''}
                        ${isAdmin ? renderSidebar('pengaturan','Pengaturan', 'M10.325 4.317c.426-1.756 2.924-1.756 3.35 0a1.724 1.724 0 002.573 1.066c1.543-.94 3.31.826 2.37 2.37a1.724 1.724 0 001.065 2.572c1.756.426 1.756 2.924 0 3.35a1.724 1.724 0 00-1.066 2.573c.94 1.543-.826 3.31-2.37 2.37a1.724 1.724 0 00-2.572 1.065c-.426 1.756-2.924 1.756-3.35 0a1.724 1.724 0 00-2.573-1.066c-1.543.94-3.31-.826-2.37-2.37a1.724 1.724 0 00-1.065-2.572c-1.756-.426-1.756-2.924 0-3.35a1.724 1.724 0 001.066-2.573c-.94-1.543.826-3.31 2.37-2.37.996.608 2.296.07 2.572-1.065z M15 12a3 3 0 11-6 0 3 3 0 016 0z') : ''}
                    </nav>
                    <div class="p-4 border-t border-slate-800">
                        <button onclick="setView('visitor')" class="w-full bg-red-500/10 hover:bg-red-600 text-red-400 hover:text-white py-3 rounded-xl font-bold transition flex items-center justify-center gap-2">
                            <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17 16l4-4m0 0l-4-4m4 4H7m6 4v1a3 3 0 01-3 3H6a3 3 0 01-3-3V7a3 3 0 013-3h7a3 3 0 013 3v1"/></svg>
                            Keluar
                        </button>
                    </div>
                </div>

                <!-- Main Content Wrapper -->
                <div class="flex-1 md:ml-64 flex flex-col min-h-screen transition-all">
                    
                    <!-- Mobile Header -->
                    <div class="md:hidden bg-white p-4 shadow-sm flex justify-between items-center sticky top-0 z-30 border-b border-slate-200">
                        <div class="flex items-center gap-2">
                            <div class="w-8 h-8 bg-emerald-500 rounded-lg flex items-center justify-center text-white font-bold">S</div>
                            <div class="font-bold text-lg text-slate-800">Panel ${isAdmin?'Admin':'Petugas'}</div>
                        </div>
                        <button onclick="setView('visitor')" class="text-xs bg-red-50 text-red-500 px-3 py-2 rounded-lg font-bold border border-red-100">Keluar</button>
                    </div>

                    <!-- Mobile Tabs -->
                    <div class="md:hidden bg-white border-b border-slate-200 overflow-x-auto flex gap-2 p-3 sticky top-[66px] z-20 no-scrollbar">
                        ${renderMTab('dashboard')}
                        ${renderMTab('anggota')}
                        ${renderMTab('buku')}
                        ${renderMTab('peminjaman')}
                        ${isAdmin ? renderMTab('laporan') : ''}
                        ${isAdmin ? renderMTab('pengaturan') : ''}
                    </div>

                    <div class="p-5 md:p-8 fade-in w-full max-w-7xl mx-auto">`;

            // --- CONTENT LOGIC ---
            if(adminTab==='dashboard') {
                content += `
                    <div class="bg-gradient-to-br from-emerald-600 to-teal-700 rounded-3xl p-8 text-white shadow-xl mb-8 relative overflow-hidden">
                        <div class="absolute top-0 right-0 w-64 h-64 bg-white/10 rounded-full -mr-16 -mt-16 blur-3xl"></div>
                        <div class="relative z-10">
                            <h2 class="text-3xl font-bold mb-2">Halo, ${currentUser.name}!</h2>
                            <p class="opacity-90 text-emerald-100">Selamat datang kembali di dashboard manajemen TBM Anak Bangsa.</p>
                        </div>
                    </div>
                    <div class="grid grid-cols-2 lg:grid-cols-4 gap-4 md:gap-6">
                        ${renderStat('Total Buku', books.length, 'blue', 'üìö')}
                        ${renderStat('Anggota', members.length, 'purple', 'üë•')}
                        ${renderStat('Dipinjam', loans.filter(l => l.status === 'Dipinjam').length, 'orange', '‚è≥')}
                        ${renderStat('Tamu Hari Ini', visitors.length, 'emerald', 'üìù')}
                    </div>`;
            }
            // ... (Bagian Data Anggota, Buku, Peminjaman sama seperti sebelumnya)
            else if(['anggota','buku','peminjaman'].includes(adminTab)) {
                content += `
                    <div class="bg-white p-5 rounded-2xl shadow-sm mb-6 border border-slate-200 flex flex-col md:flex-row md:items-end gap-4">
                        <div class="flex-1">
                            <label class="text-[11px] font-bold text-slate-400 uppercase tracking-wide mb-1 block">Pencarian</label>
                            <div class="relative">
                                <span class="absolute left-3 top-1/2 -translate-y-1/2 text-slate-400">üîç</span>
                                <input type="text" placeholder="Cari data..." class="input-field pl-10" value="${searchTerm}" oninput="searchTerm=this.value; render()">
                            </div>
                        </div>
                        ${adminTab === 'peminjaman' ? `
                        <div class="grid grid-cols-2 gap-2 md:w-1/3">
                            <div>
                                <label class="text-[11px] font-bold text-slate-400 uppercase tracking-wide mb-1 block">Dari</label>
                                <input type="date" class="input-field" value="${filterStart}" onchange="filterStart=this.value; render()">
                            </div>
                            <div>
                                <label class="text-[11px] font-bold text-slate-400 uppercase tracking-wide mb-1 block">Sampai</label>
                                <input type="date" class="input-field" value="${filterEnd}" onchange="filterEnd=this.value; render()">
                            </div>
                        </div>` : ''}
                        <div class="flex gap-2 mt-2 md:mt-0">
                            ${isAdmin ? `<button onclick="printRecapNew('${adminTab}')" class="bg-slate-800 text-white px-5 py-2.5 rounded-xl font-bold shadow hover:bg-slate-700 flex items-center gap-2 transition"><svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17 17h2a2 2 0 002-2v-4a2 2 0 00-2-2H5a2 2 0 00-2 2v4a2 2 0 002 2h2m2 4h6a2 2 0 002-2v-4a2 2 0 00-2-2H9a2 2 0 00-2 2v4a2 2 0 002 2zm8-12V5a2 2 0 00-2-2H9a2 2 0 00-2 2v4h10z"/></svg><span class="hidden sm:inline">Cetak</span></button>` : ''}
                            <button onclick="${adminTab==='anggota'?'modalAnggota()':adminTab==='buku'?'modalBuku()':'modalPinjam()'}" class="bg-emerald-600 text-white px-5 py-2.5 rounded-xl font-bold shadow hover:bg-emerald-700 flex items-center gap-2 transition"><svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4v16m8-8H4"/></svg><span class="hidden sm:inline">Tambah</span></button>
                        </div>
                    </div>`;

                if(adminTab==='anggota') {
                    const filtered = members.filter(m => m.name.toLowerCase().includes(searchTerm.toLowerCase()) || m.id.includes(searchTerm));
                    content += `<div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-5 pb-20">${filtered.length ? filtered.map(m => renderMemberCard(m)).join('') : '<div class="col-span-full text-center py-20 text-slate-400">Data tidak ditemukan</div>'}</div>`;
                } else if(adminTab==='buku') {
                    const filtered = books.filter(b => b.title.toLowerCase().includes(searchTerm.toLowerCase()) || b.author.toLowerCase().includes(searchTerm.toLowerCase()));
                    content += `<div class="grid grid-cols-1 md:grid-cols-2 gap-4 pb-20">${filtered.length ? filtered.map(b => renderBookCard(b)).join('') : '<div class="col-span-full text-center py-20 text-slate-400">Data tidak ditemukan</div>'}</div>`;
                } else {
                    let f = loans.filter(l => l.bookTitle.toLowerCase().includes(searchTerm.toLowerCase()) || l.memberName.toLowerCase().includes(searchTerm.toLowerCase()));
                    if(filterStart && filterEnd) f = f.filter(l => l.date >= filterStart && l.date <= filterEnd);
                    content += `<div class="space-y-3 pb-20">${f.length === 0 ? '<div class="text-center text-slate-400 py-20 border-2 border-dashed border-slate-200 rounded-3xl">Tidak ada data sirkulasi.</div>' : ''}${f.slice().reverse().map(l => renderLoanCard(l)).join('')}</div>`;
                }
            }
            else if(adminTab==='laporan' && isAdmin) {
                content += `
                <div class="grid grid-cols-1 lg:grid-cols-2 gap-6 pb-20">
                    <!-- Laporan Panel -->
                    <div class="bg-white p-6 rounded-3xl shadow-sm border border-slate-200 h-fit">
                        <div class="flex items-center gap-4 mb-6 pb-4 border-b border-slate-100">
                            <div class="w-12 h-12 bg-blue-50 text-blue-600 rounded-2xl flex items-center justify-center text-2xl">üìä</div>
                            <div><h3 class="font-bold text-lg text-slate-800">Laporan & Rekap</h3><p class="text-sm text-slate-500">Cetak laporan periodik</p></div>
                        </div>
                        <div class="space-y-5">
                            <div class="grid grid-cols-2 gap-3 bg-slate-50 p-4 rounded-2xl border border-slate-100">
                                <div><label class="text-[11px] font-bold text-slate-400 uppercase tracking-wide">Dari</label><input type="date" id="repStart" class="input-field bg-white h-10 mt-1"></div>
                                <div><label class="text-[11px] font-bold text-slate-400 uppercase tracking-wide">Sampai</label><input type="date" id="repEnd" class="input-field bg-white h-10 mt-1"></div>
                            </div>
                            <div class="space-y-3">
                                <button onclick="printRecapNew('anggota')" class="w-full flex justify-between items-center p-4 border border-slate-100 rounded-2xl hover:bg-slate-50 hover:border-slate-300 transition group">
                                    <div class="flex items-center gap-3"><span class="text-xl">üë•</span> <span class="font-bold text-slate-700">Data Anggota</span></div>
                                    <span class="bg-slate-100 text-slate-600 px-3 py-1 rounded-lg text-xs font-bold group-hover:bg-slate-200">CETAK SEMUA</span>
                                </button>
                                <button onclick="printRecapNew('buku')" class="w-full flex justify-between items-center p-4 border border-slate-100 rounded-2xl hover:bg-slate-50 hover:border-slate-300 transition group">
                                    <div class="flex items-center gap-3"><span class="text-xl">üìö</span> <span class="font-bold text-slate-700">Stok Buku</span></div>
                                    <span class="bg-slate-100 text-slate-600 px-3 py-1 rounded-lg text-xs font-bold group-hover:bg-slate-200">CETAK SEMUA</span>
                                </button>
                                <button onclick="printRecapSirkulasiCustom('peminjaman')" class="w-full flex justify-between items-center p-4 border border-orange-100 bg-orange-50/50 rounded-2xl hover:bg-orange-50 hover:border-orange-300 transition group">
                                    <div class="flex items-center gap-3"><span class="text-xl">üîÑ</span> <span class="font-bold text-slate-700">Sirkulasi Peminjaman</span></div>
                                    <span class="bg-orange-100 text-orange-700 px-3 py-1 rounded-lg text-xs font-bold group-hover:bg-orange-200">CETAK PERIODE</span>
                                </button>
                                <button onclick="printRecapSirkulasiCustom('visitor')" class="w-full flex justify-between items-center p-4 border border-purple-100 bg-purple-50/50 rounded-2xl hover:bg-purple-50 hover:border-purple-300 transition group">
                                    <div class="flex items-center gap-3"><span class="text-xl">üìù</span> <span class="font-bold text-slate-700">Buku Tamu</span></div>
                                    <span class="bg-purple-100 text-purple-700 px-3 py-1 rounded-lg text-xs font-bold group-hover:bg-purple-200">CETAK PERIODE</span>
                                </button>
                            </div>
                        </div>
                    </div>

                    <!-- Cetak Kartu Panel -->
                    <div class="bg-white p-6 rounded-3xl shadow-sm border border-slate-200 h-fit">
                        <div class="flex items-center gap-4 mb-6 pb-4 border-b border-slate-100">
                            <div class="w-12 h-12 bg-emerald-50 text-emerald-600 rounded-2xl flex items-center justify-center text-2xl">üÜî</div>
                            <div><h3 class="font-bold text-lg text-slate-800">Cetak Kartu Anggota</h3><p class="text-sm text-slate-500">Cari anggota untuk mencetak kartu</p></div>
                        </div>
                        <div class="relative mb-4">
                            <span class="absolute left-3 top-1/2 -translate-y-1/2 text-slate-400">üîç</span>
                            <input type="text" placeholder="Ketik nama atau ID..." class="input-field pl-10" value="${printSearch}" oninput="printSearch=this.value; render()">
                        </div>
                        <div class="space-y-2 max-h-[400px] overflow-y-auto custom-scrollbar pr-1">
                            ${members.filter(m => m.name.toLowerCase().includes(printSearch.toLowerCase())).map(m => `
                                <div class="flex items-center justify-between p-3 border border-slate-100 rounded-xl hover:bg-emerald-50 hover:border-emerald-200 transition group">
                                    <div class="flex items-center gap-3">
                                        <div class="w-10 h-10 bg-slate-100 rounded-full overflow-hidden border border-slate-200">
                                            ${m.photo ? `<img src="${m.photo}" class="w-full h-full object-cover">` : `<div class="w-full h-full flex items-center justify-center text-[10px] font-bold text-slate-400">${m.name[0]}</div>`}
                                        </div>
                                        <div>
                                            <div class="font-bold text-sm text-slate-700">${m.name}</div>
                                            <div class="text-[10px] text-slate-400 font-mono bg-slate-100 px-1 rounded inline-block">${m.id}</div>
                                        </div>
                                    </div>
                                    <button onclick="printCardNew('${m.id}')" class="text-xs bg-white border border-emerald-200 text-emerald-600 px-3 py-2 rounded-lg font-bold shadow-sm hover:bg-emerald-600 hover:text-white transition">CETAK</button>
                                </div>`).join('')}
                        </div>
                    </div>
                </div>`;
            }
            else if(adminTab==='pengaturan' && isAdmin) {
                content += `
                <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                    <div class="bg-white p-6 rounded-3xl shadow-sm border border-slate-200">
                        <div class="flex justify-between items-center mb-6 pb-4 border-b border-slate-100">
                            <div><h3 class="font-bold text-lg text-slate-800">Manajemen Akses</h3><p class="text-sm text-slate-500">Kelola akun petugas</p></div>
                            <button onclick="modalUser()" class="bg-slate-800 text-white px-4 py-2 rounded-xl font-bold text-xs hover:bg-slate-900 shadow">+ User Baru</button>
                        </div>
                        <div class="space-y-3">
                            ${users.map(u => `
                                <div class="flex items-center justify-between p-4 border rounded-xl bg-slate-50/50">
                                    <div class="flex items-center gap-4">
                                        <div class="w-10 h-10 ${u.role === 'admin' ? 'bg-emerald-100 text-emerald-600' : 'bg-blue-100 text-blue-600'} rounded-full flex items-center justify-center font-bold uppercase text-sm">${u.role.substring(0,2)}</div>
                                        <div><div class="font-bold text-slate-800">${u.name}</div><div class="text-[10px] font-bold text-slate-400 uppercase tracking-wider">${u.role}</div></div>
                                    </div>
                                    <div class="flex items-center gap-2">
                                        ${u.role !== 'admin' ? `
                                            <button onclick="modalUser('${u.id}')" class="w-8 h-8 flex items-center justify-center rounded-full bg-white border border-slate-200 text-orange-500 hover:border-orange-500 transition">‚úé</button>
                                            <button onclick="deleteUser('${u.id}')" class="w-8 h-8 flex items-center justify-center rounded-full bg-white border border-slate-200 text-red-500 hover:border-red-500 transition">‚úï</button>
                                        ` : '<span class="text-[10px] font-bold text-slate-400 bg-slate-200 px-2 py-1 rounded">UTAMA</span>'}
                                    </div>
                                </div>`).join('')}
                        </div>
                    </div>
                    <div class="bg-white p-6 rounded-3xl shadow-sm border border-slate-200 h-fit">
                        <h3 class="font-bold text-lg text-slate-800 mb-2">Reset Aplikasi</h3>
                        <p class="text-sm text-slate-500 mb-4">Hapus semua data dan kembali ke pengaturan awal. Gunakan dengan hati-hati.</p>
                        <button onclick="if(confirm('PERINGATAN: Semua data akan dihapus. Lanjutkan?')){localStorage.clear();location.reload();}" class="w-full border border-red-200 text-red-500 bg-red-50 hover:bg-red-600 hover:text-white py-3 rounded-xl font-bold transition">Reset Data ke Awal</button>
                    </div>
                </div>`;
            }

            content += `</div></div></div>`; 
            container.innerHTML = content;
        }

        // --- COMPONENT HELPERS (Sama seperti sebelumnya) ---
        function renderSidebar(id, label, iconPath) {
            const active = adminTab === id;
            return `<button onclick="setTab('${id}')" class="w-full text-left px-4 py-3.5 rounded-xl transition-all flex items-center gap-3 ${active ? 'bg-emerald-600 text-white font-semibold shadow-lg shadow-emerald-900/20' : 'text-slate-400 hover:bg-slate-800 hover:text-emerald-400'}">
                <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="${iconPath}"/></svg>
                ${label}
            </button>`;
        }
        function renderMTab(id) {
            let lbl = id === 'laporan' ? 'Laporan' : id.charAt(0).toUpperCase() + id.slice(1);
            const active = adminTab === id;
            return `<button onclick="setTab('${id}')" class="px-4 py-2 rounded-full text-xs font-bold whitespace-nowrap transition-colors ${active ? 'bg-emerald-600 text-white shadow' : 'bg-slate-100 text-slate-500 border border-slate-200'}">${lbl}</button>`;
        }
        function renderStat(l, v, c, icon) {
            const colors = {
                blue: 'text-blue-600 bg-blue-50 border-blue-100',
                purple: 'text-purple-600 bg-purple-50 border-purple-100',
                orange: 'text-orange-600 bg-orange-50 border-orange-100',
                emerald: 'text-emerald-600 bg-emerald-50 border-emerald-100'
            };
            return `<div class="p-5 rounded-2xl border shadow-sm ${colors[c]} flex flex-col justify-between h-28 relative overflow-hidden group">
                <div class="absolute right-0 top-0 p-4 opacity-10 text-6xl grayscale group-hover:grayscale-0 transition-all transform group-hover:scale-110 group-hover:rotate-12">${icon}</div>
                <div class="text-3xl font-extrabold relative z-10">${v}</div>
                <div class="text-xs font-bold uppercase tracking-wider opacity-70 relative z-10">${l}</div>
            </div>`;
        }
        function renderMemberCard(m) {
            const showEdit = canEdit(m);
            return `
            <div class="bg-white p-5 rounded-2xl border border-slate-200 shadow-sm hover:shadow-lg transition-all relative group flex flex-col h-full">
                <div class="flex items-center gap-4 mb-4">
                    <div class="w-14 h-14 bg-slate-100 rounded-full overflow-hidden flex-shrink-0 border-2 border-white shadow-sm">
                        ${m.photo ? `<img src="${m.photo}" class="w-full h-full object-cover">` : `<div class="w-full h-full flex items-center justify-center text-slate-400 font-bold text-xl">${m.name[0]}</div>`}
                    </div>
                    <div class="min-w-0 overflow-hidden">
                        <h4 class="font-bold text-base text-slate-800 truncate">${m.name}</h4>
                        <p class="text-[10px] font-bold text-slate-500 bg-slate-100 px-2 py-0.5 rounded inline-block mt-1 uppercase tracking-wide">${m.type}</p>
                    </div>
                </div>
                <div class="text-xs text-slate-500 mb-4 space-y-1 flex-1">
                    <div class="flex justify-between border-b border-dashed border-slate-100 pb-1"><span>ID</span> <span class="font-mono text-slate-700">${m.id}</span></div>
                    <div class="flex justify-between pt-1"><span>Status</span> <span class="${m.active ? 'text-emerald-600' : 'text-red-500'} font-bold bg-${m.active ? 'emerald' : 'red'}-50 px-1.5 rounded">${m.active ? 'AKTIF' : 'NONAKTIF'}</span></div>
                </div>
                <div class="flex gap-2 pt-3 border-t border-slate-100 mt-auto">
                    <button onclick="modalDetail('anggota','${m.id}')" class="flex-1 bg-blue-50 text-blue-600 py-2 rounded-lg text-xs font-bold hover:bg-blue-100 transition">Detail</button>
                    ${showEdit ? `<button onclick="modalAnggota('${m.id}')" class="flex-1 bg-orange-50 text-orange-600 py-2 rounded-lg text-xs font-bold hover:bg-orange-100 transition">Edit</button>` : ''}
                </div>
                ${showEdit ? `<button onclick="deleteItem('m','${m.id}')" class="absolute top-4 right-4 text-slate-300 hover:text-red-500 transition font-bold">&times;</button>` : ''}
            </div>`;
        }
        function renderBookCard(b) {
            const showEdit = canEdit(b);
            return `
            <div class="bg-white p-4 rounded-2xl border border-slate-200 shadow-sm hover:shadow-md transition flex flex-col h-full relative">
                <div class="flex-1">
                    <div class="flex justify-between items-start">
                        <h4 class="font-bold text-base text-slate-800 line-clamp-2 leading-tight mb-1">${b.title}</h4>
                    </div>
                    <p class="text-xs text-slate-500 mb-3">${b.author}</p>
                    <div class="flex flex-wrap gap-1 mb-3">
                        <span class="text-[10px] bg-slate-100 text-slate-600 px-2 py-1 rounded font-medium">${b.category}</span>
                        <span class="text-[10px] bg-slate-100 text-slate-600 px-2 py-1 rounded font-medium">Rak: ${b.shelf}</span>
                    </div>
                </div>
                <div class="flex justify-between items-center mt-auto pt-3 border-t border-slate-100">
                    <span class="${b.stock > 0 ? 'text-emerald-700 bg-emerald-50' : 'text-red-700 bg-red-50'} px-2 py-1 rounded text-xs font-bold">Stok: ${b.stock}</span>
                    <div class="flex gap-1">
                        <button onclick="modalDetail('buku', ${b.id})" class="w-8 h-8 flex items-center justify-center rounded-lg bg-blue-50 text-blue-600 hover:bg-blue-100">üëÅÔ∏è</button>
                        ${showEdit ? `<button onclick="modalBuku(${b.id})" class="w-8 h-8 flex items-center justify-center rounded-lg bg-orange-50 text-orange-600 hover:bg-orange-100">‚úé</button>` : ''}
                    </div>
                </div>
                ${showEdit ? `<button onclick="deleteItem('b',${b.id})" class="absolute top-2 right-2 w-6 h-6 flex items-center justify-center text-slate-300 hover:text-red-500 hover:bg-red-50 rounded transition">&times;</button>` : ''}
            </div>`;
        }
        function renderLoanCard(l) {
            const showEdit = canEdit(l);
            return `
            <div class="bg-white p-4 rounded-2xl border-l-4 ${l.status === 'Dipinjam' ? 'border-orange-400' : 'border-emerald-400'} shadow-sm hover:shadow-md transition relative flex justify-between items-center">
                <div>
                    <div class="text-xs text-slate-400 font-mono mb-1">#${l.id} ‚Ä¢ ${l.date}</div>
                    <h4 class="font-bold text-slate-800">${l.bookTitle}</h4>
                    <p class="text-sm text-slate-600 mt-0.5">Peminjam: <span class="font-semibold text-emerald-700">${l.memberName}</span></p>
                </div>
                <div class="flex flex-col items-end gap-2">
                    <span class="px-2.5 py-1 rounded-md text-[10px] font-bold uppercase tracking-wide ${l.status === 'Dipinjam' ? 'bg-orange-50 text-orange-600 ring-1 ring-orange-200' : 'bg-emerald-50 text-emerald-600 ring-1 ring-emerald-200'}">${l.status}</span>
                    <div class="flex gap-2 mt-1">
                        <button onclick="printDetail(${l.id})" class="text-xs text-slate-500 bg-slate-100 hover:bg-slate-200 px-2 py-1 rounded font-bold">Struk</button>
                        ${l.status === 'Dipinjam' && showEdit ? `<button onclick="kembalikanBuku(${l.id})" class="bg-emerald-600 text-white px-3 py-1 rounded-lg text-xs font-bold shadow hover:bg-emerald-700">Kembali</button>` : ''}
                    </div>
                </div>
            </div>`;
        }

        /**
         * ------------------------------------------------------------------
         * MODAL & FORM HANDLERS (Sama seperti sebelumnya)
         * ------------------------------------------------------------------
         */
        const overlay = document.getElementById('modalOverlay');
        const mTitle = document.getElementById('modalTitle');
        const mContent = document.getElementById('modalContent');

        function openModal(t, h) { mTitle.innerText = t; mContent.innerHTML = h; overlay.classList.remove('hidden'); overlay.classList.add('flex'); }
        function closeModal() { overlay.classList.add('hidden'); overlay.classList.remove('flex'); photoPreview = null; editId = null; editUserId = null; }

        function openLoginModal() {
            openModal('Masuk Panel Admin', `
                <form onsubmit="processLogin(event)" class="space-y-4 pt-2">
                    <div><label class="text-[11px] font-bold text-slate-400 uppercase tracking-wide">Username</label><input name="u" required class="input-field mt-1" placeholder="Username (Default: admin)"></div>
                    <div><label class="text-[11px] font-bold text-slate-400 uppercase tracking-wide">Password</label><input type="password" name="p" required class="input-field mt-1" placeholder="Password (Default: admin)"></div>
                    <div class="pt-2">
                        <button class="w-full bg-emerald-600 text-white py-3 rounded-xl font-bold hover:bg-emerald-700 shadow-lg shadow-emerald-500/30 transition">MASUK APLIKASI</button>
                        <button type="button" onclick="closeModal()" class="w-full mt-2 text-slate-400 text-sm py-2 hover:text-slate-600">Batal</button>
                    </div>
                </form>`);
        }
        function processLogin(e) { e.preventDefault(); login(e.target.u.value, e.target.p.value); }

        // ... (Fungsi modalUser, saveUser, deleteUser, modalAnggota, handleMemberSubmit, modalBuku, handleBookSubmit, modalPinjam, handleLoanSubmit SAMA SEPERTI SEBELUMNYA) ...
        
        // MANAGE USER
        function modalUser(id = null) {
            const u = id ? users.find(x => x.id === id) : {};
            editUserId = id;
            openModal(id ? 'Edit Petugas' : 'Tambah Petugas', `
                <form onsubmit="saveUser(event)" class="space-y-4">
                    <div><label class="text-[11px] font-bold text-slate-400 uppercase tracking-wide">Nama Petugas</label><input name="name" value="${u.name || ''}" required class="input-field mt-1"></div>
                    <div><label class="text-[11px] font-bold text-slate-400 uppercase tracking-wide">Password</label><input type="text" name="password" value="${u.password || ''}" required class="input-field mt-1"></div>
                    <div class="flex gap-3 pt-2">
                        <button type="button" onclick="closeModal()" class="flex-1 bg-slate-100 text-slate-600 py-3 rounded-xl font-bold">Batal</button>
                        <button class="flex-1 bg-emerald-600 text-white py-3 rounded-xl font-bold hover:bg-emerald-700 shadow-lg">Simpan</button>
                    </div>
                </form>`);
        }
        function saveUser(e) {
            e.preventDefault();
            const n = e.target.name.value;
            const p = e.target.password.value;
            if(editUserId) users = users.map(u => u.id === editUserId ? { ...u, name: n, password: p } : u);
            else users.push({ id: 'petugas_' + Date.now(), name: n, role: 'petugas', password: p, active: true });
            saveData(); closeModal();
        }
        function deleteUser(id) { if(confirm('Hapus akses petugas ini?')) { users = users.filter(x => x.id !== id); saveData(); } }

        // ANGGOTA
        function modalAnggota(id = null) {
            const d = id ? members.find(m => m.id === id) : {};
            editId = id;
            photoPreview = d.photo || null;
            const newID = id || `AGT-${new Date().getFullYear()}${Math.floor(Math.random() * 9000) + 1000}`;
            
            openModal(id ? 'Edit Anggota' : 'Tambah Anggota', `
                <form onsubmit="handleMemberSubmit(event)" class="space-y-3">
                    <div class="flex justify-center mb-2">
                        <label class="w-24 h-24 bg-slate-50 rounded-full flex items-center justify-center border-2 border-dashed border-slate-300 hover:border-emerald-500 cursor-pointer overflow-hidden relative transition group">
                            <img id="preview" src="${photoPreview || ''}" class="${photoPreview ? '' : 'hidden'} w-full h-full object-cover absolute">
                            <div class="text-center z-10 ${photoPreview ? 'hidden group-hover:block bg-black/50 w-full h-full flex items-center justify-center' : ''}">
                                <span class="text-xs text-slate-400 group-hover:text-white font-bold">üì∑ Foto</span>
                            </div>
                            <input type="file" class="hidden" onchange="handlePhoto(this)" accept="image/*">
                        </label>
                    </div>
                    <div class="grid grid-cols-2 gap-3">
                        <div><label class="text-[10px] font-bold text-slate-400 uppercase">ID (Oto)</label><input name="mid" value="${newID}" readonly class="input-field bg-slate-100 text-center font-mono font-bold text-slate-500"></div>
                        <div><label class="text-[10px] font-bold text-slate-400 uppercase">NIK</label><input name="nik" value="${d.nik || ''}" placeholder="NIK KTP/Kartu Pelajar" class="input-field"></div>
                    </div>
                    <div><label class="text-[10px] font-bold text-slate-400 uppercase">Nama Lengkap</label><input name="name" value="${d.name || ''}" required class="input-field"></div>
                    <div class="grid grid-cols-2 gap-3">
                        <div><label class="text-[10px] font-bold text-slate-400 uppercase">Tempat Lahir</label><input name="bPlace" value="${d.birthPlace || ''}" class="input-field"></div>
                        <div><label class="text-[10px] font-bold text-slate-400 uppercase">Tgl Lahir</label><input name="bDate" type="date" value="${d.birthDate || ''}" class="input-field"></div>
                    </div>
                    <div class="grid grid-cols-2 gap-3">
                        <div><label class="text-[10px] font-bold text-slate-400 uppercase">Gender</label><select name="gender" class="input-field"><option value="L" ${d.gender=='L'?'selected':''}>Laki-laki</option><option value="P" ${d.gender=='P'?'selected':''}>Perempuan</option></select></div>
                        <div><label class="text-[10px] font-bold text-slate-400 uppercase">Tipe</label><select name="type" class="input-field"><option ${d.type === 'Umum' ? 'selected' : ''}>Umum</option><option ${d.type === 'Pelajar' ? 'selected' : ''}>Pelajar</option></select></div>
                    </div>
                    <div><label class="text-[10px] font-bold text-slate-400 uppercase">No HP</label><input name="phone" value="${d.phone || ''}" class="input-field"></div>
                    <div><label class="text-[10px] font-bold text-slate-400 uppercase">Alamat</label><textarea name="addr" rows="2" class="input-field">${d.address || ''}</textarea></div>
                    <div class="flex gap-3 pt-2">
                        <button type="button" onclick="closeModal()" class="flex-1 bg-slate-100 text-slate-600 py-3 rounded-xl font-bold">Batal</button>
                        <button class="flex-1 bg-emerald-600 text-white py-3 rounded-xl font-bold hover:bg-emerald-700 shadow-lg">Simpan Data</button>
                    </div>
                </form>`);
        }
        function handleMemberSubmit(e) {
            e.preventDefault();
            const f = e.target;
            const d = {
                id: f.mid.value, nik: f.nik.value, name: f.name.value,
                birthPlace: f.bPlace.value, birthDate: f.bDate.value, gender: f.gender.value,
                type: f.type.value, phone: f.phone.value, address: f.addr.value,
                photo: photoPreview, active: true,
                createdBy: currentUser ? currentUser.id : 'admin',
                joinDate: editId ? (members.find(m=>m.id===editId).joinDate) : new Date().toISOString().slice(0, 10)
            };
            if(editId) members = members.map(m => m.id === editId ? { ...m, ...d } : m);
            else members.push(d);
            saveData(); closeModal();
        }

        // BUKU
        function modalBuku(id = null) {
            const d = id ? books.find(b => b.id === id) : {};
            editId = id;
            openModal(id ? 'Edit Buku' : 'Tambah Buku', `
                <form onsubmit="handleBookSubmit(event)" class="space-y-3">
                    <div><label class="text-[10px] font-bold text-slate-400 uppercase">Judul Buku</label><input name="title" value="${d.title || ''}" required class="input-field"></div>
                    <div><label class="text-[10px] font-bold text-slate-400 uppercase">ISBN</label><input name="isbn" value="${d.isbn || ''}" class="input-field"></div>
                    <div><label class="text-[10px] font-bold text-slate-400 uppercase">Penulis</label><input name="author" value="${d.author || ''}" class="input-field"></div>
                    <div class="grid grid-cols-2 gap-2">
                        <div><label class="text-[10px] font-bold text-slate-400 uppercase">Kategori</label><input name="category" value="${d.category || ''}" class="input-field" list="catList"><datalist id="catList"><option value="Novel"><option value="Sastra"><option value="Pelajaran"><option value="Komik"></datalist></div>
                        <div><label class="text-[10px] font-bold text-slate-400 uppercase">Stok</label><input name="stock" type="number" value="${d.stock || ''}" class="input-field"></div>
                    </div>
                    <div><label class="text-[10px] font-bold text-slate-400 uppercase">Lokasi Rak</label><input name="shelf" value="${d.shelf || ''}" class="input-field"></div>
                    <div class="flex gap-3 pt-2">
                        <button type="button" onclick="closeModal()" class="flex-1 bg-slate-100 text-slate-600 py-3 rounded-xl font-bold">Batal</button>
                        <button class="flex-1 bg-emerald-600 text-white py-3 rounded-xl font-bold hover:bg-emerald-700 shadow-lg">Simpan Buku</button>
                    </div>
                </form>`);
        }
        function handleBookSubmit(e) {
            e.preventDefault();
            const f = e.target;
            const d = {
                id: editId || Date.now(), title: f.title.value, isbn: f.isbn.value,
                author: f.author.value, category: f.category.value,
                stock: parseInt(f.stock.value), shelf: f.shelf.value,
                createdBy: currentUser ? currentUser.id : 'admin'
            };
            if(editId) books = books.map(b => b.id === editId ? d : b);
            else books.push(d);
            saveData(); closeModal();
        }

        // PINJAM
        function modalPinjam() {
            const opts = members.filter(m => m.active).map(m => `<option value="${m.id}">${m.name} (${m.id})</option>`).join('');
            const bopts = books.filter(b => b.stock > 0).map(b => `<option value="${b.id}">${b.title}</option>`).join('');
            
            if(!bopts) return alert("Tidak ada buku yang tersedia (Stok Habis).");
            if(!opts) return alert("Tidak ada anggota aktif.");

            openModal('Transaksi Peminjaman', `
                <form onsubmit="handleLoanSubmit(event)" class="space-y-4">
                    <div class="grid grid-cols-1 gap-3">
                        <div><label class="text-[10px] font-bold text-slate-400 uppercase">Peminjam</label><select name="mid" class="input-field">${opts}</select></div>
                        <div><label class="text-[10px] font-bold text-slate-400 uppercase">Buku (Yang tersedia)</label><select name="bid" class="input-field">${bopts}</select></div>
                    </div>
                    <div class="grid grid-cols-2 gap-3">
                        <div><label class="text-[10px] font-bold text-slate-400 uppercase">Tgl Pinjam</label><input name="d" type="date" value="${new Date().toISOString().slice(0, 10)}" class="input-field"></div>
                        <div><label class="text-[10px] font-bold text-slate-400 uppercase">Rencana Kembali</label><input name="r" type="date" class="input-field" required></div>
                    </div>
                    <div><label class="text-[10px] font-bold text-slate-400 uppercase">Kondisi Awal</label><select name="cond" class="input-field"><option>Baik</option><option>Rusak Ringan</option></select></div>
                    <div class="flex gap-3 pt-2">
                        <button type="button" onclick="closeModal()" class="flex-1 bg-slate-100 text-slate-600 py-3 rounded-xl font-bold">Batal</button>
                        <button class="flex-1 bg-orange-500 text-white py-3 rounded-xl font-bold hover:bg-orange-600 shadow-lg">Proses Pinjam</button>
                    </div>
                </form>`);
        }
        function handleLoanSubmit(e) {
            e.preventDefault();
            const f = e.target;
            const m = members.find(x => x.id == f.mid.value);
            const b = books.find(x => x.id == f.bid.value);
            
            if(b.stock <= 0) return alert("Stok buku habis!");

            b.stock--; // Kurangi stok
            loans.push({
                id: Date.now(), memberId: m.id, memberName: m.name,
                bookTitle: b.title, bookId: b.id, status: 'Dipinjam',
                date: f.d.value, returnDate: f.r.value, cond: f.cond.value,
                createdBy: currentUser ? currentUser.id : 'admin'
            });
            saveData(); closeModal();
        }

        // BUKU TAMU
        function openVisitorForm() {
            openModal('Buku Tamu - TBM Anak Bangsa', `
                <form onsubmit="handleVisitorSubmit(event)" class="space-y-4">
                    <div><label class="text-[10px] font-bold text-slate-400 uppercase ml-1">Nama Lengkap</label><input id="vName" required class="input-field mt-1" placeholder="Nama Anda"></div>
                    <div class="grid grid-cols-2 gap-3">
                        <div><label class="text-[10px] font-bold text-slate-400 uppercase ml-1">Pekerjaan</label><input id="vJob" class="input-field mt-1" placeholder="Pekerjaan Anda"></div>
                        <div><label class="text-[10px] font-bold text-slate-400 uppercase ml-1">No. HP (Opsional)</label><input id="vPhone" type="number" class="input-field mt-1"></div>
                    </div>
                    <div class="grid grid-cols-2 gap-3">
                        <div><label class="text-[10px] font-bold text-slate-400 uppercase ml-1">Asal Instansi/Kota</label><input id="vOrigin" class="input-field mt-1"></div>
                        <div><label class="text-[10px] font-bold text-slate-400 uppercase ml-1">Keperluan</label><select id="vPurpose" class="input-field mt-1"><option>Baca Buku</option><option>Pinjam Buku</option><option>Kerja Tugas</option><option>Rekreasi</option><option>Lainnya</option></select></div>
                    </div>
                    <div><label class="text-[10px] font-bold text-slate-400 uppercase ml-1">Alamat Lengkap</label><textarea id="vAddr" rows="2" class="input-field mt-1"></textarea></div>
                    <div class="flex gap-3 pt-2">
                        <button type="button" onclick="closeModal()" class="flex-1 bg-slate-100 text-slate-600 py-3 rounded-xl font-bold">Batal</button>
                        <button class="flex-1 bg-orange-500 text-white py-3 rounded-xl font-bold shadow-lg hover:bg-orange-600">Check In</button>
                    </div>
                </form>`);
        }
        function handleVisitorSubmit(e) {
            e.preventDefault();
            visitors.push({
                date: new Date().toISOString().slice(0, 10),
                name: document.getElementById('vName').value,
                phone: document.getElementById('vPhone').value || '-',
                job: document.getElementById('vJob').value || '-',
                origin: document.getElementById('vOrigin').value || '-',
                purpose: document.getElementById('vPurpose').value,
                address: document.getElementById('vAddr').value || '-'
            });
            saveData(); closeModal(); alert("Terima kasih! Kunjungan Anda telah tercatat.");
        }

        // --- KATALOG ---
        function openCatalog() { catalogSearch = ''; renderCatalogModal(); }
        function renderCatalogModal() {
            const f = books.filter(b => b.title.toLowerCase().includes(catalogSearch.toLowerCase()) || b.author.toLowerCase().includes(catalogSearch.toLowerCase()));
            const h = `
                <div class="sticky top-0 bg-white pb-2 z-10">
                    <input placeholder="Cari judul atau pengarang..." class="input-field mb-2" oninput="catalogSearch=this.value;renderCatalogModal()" value="${catalogSearch}" autoFocus>
                </div>
                <div class="space-y-2 max-h-[300px] overflow-y-auto custom-scrollbar pr-2">
                    ${f.length ? f.map(b => `
                        <div class="border border-slate-100 p-3 rounded-xl flex justify-between text-sm hover:bg-slate-50 transition">
                            <div>
                                <div class="font-bold text-slate-800 text-base">${b.title}</div>
                                <div class="text-xs text-slate-500">${b.author}</div>
                                <div class="text-[10px] text-slate-400 bg-slate-100 px-2 py-0.5 rounded inline-block mt-1 border border-slate-200">${b.category} ‚Ä¢ Rak <b>${b.shelf}</b></div>
                            </div>
                            <div class="flex flex-col items-end justify-center">
                                <span class="${b.stock > 0 ? 'text-green-600 bg-green-50 border-green-100' : 'text-red-600 bg-red-50 border-red-100'} border font-bold px-2 py-1 rounded text-xs">${b.stock > 0 ? 'Ada' : 'Habis'}</span>
                            </div>
                        </div>`).join('') : '<div class="text-center text-slate-400 mt-4 py-4 bg-slate-50 rounded-xl">Buku tidak ditemukan.</div>'}
                </div>
                <button onclick="closeModal()" class="w-full mt-4 bg-slate-100 text-slate-600 py-2 rounded-xl font-bold">Tutup</button>`;
            
            const el = document.getElementById('catalogList');
            if(el && document.getElementById('modalContent').contains(el)) {
                el.innerHTML = h;
                const inp = el.querySelector('input');
                inp.focus(); 
                inp.setSelectionRange(inp.value.length, inp.value.length);
            } else {
                openModal('Katalog TBM Anak Bangsa', `<div id="catalogList" class="w-full">${h}</div>`);
            }
        }

        // --- LOGIC LAIN ---
        function handlePhoto(i) {
            if(i.files[0]) {
                const r = new FileReader();
                r.onload = e => {
                    photoPreview = e.target.result;
                    const prev = document.getElementById('preview');
                    prev.src = photoPreview;
                    prev.classList.remove('hidden');
                };
                r.readAsDataURL(i.files[0]);
            }
        }
        function kembalikanBuku(id) {
            if(confirm('Konfirmasi pengembalian buku? Stok akan bertambah otomatis.')) {
                const l = loans.find(x => x.id == id);
                l.status = 'Dikembalikan';
                const b = books.find(x => x.id == l.bookId);
                if(b) b.stock++;
                saveData();
            }
        }
        function deleteItem(type, id) {
            const item = (type === 'm' ? members : books).find(i => i.id === id);
            if(!canEdit(item)) return alert("Akses Ditolak: Hanya Admin atau pembuat data yang bisa menghapus.");
            if(confirm('Yakin ingin menghapus data ini secara permanen?')) {
                if(type == 'm') members = members.filter(m => m.id !== id);
                else books = books.filter(b => b.id !== id);
                saveData();
            }
        }
        function modalDetail(type, id) {
            const d = (type === 'anggota' ? members.find(x => x.id === id) : type === 'buku' ? books.find(x => x.id === id) : loans.find(x => x.id === id));
            const labels = {
                id: "ID Sistem", title: "Judul Buku", author: "Penulis", isbn: "No. ISBN", category: "Kategori", stock: "Sisa Stok", shelf: "Lokasi Rak",
                name: "Nama Lengkap", nik: "NIK/NIS", type: "Keanggotaan", gender: "Jenis Kelamin", birthPlace: "Tempat Lahir", birthDate: "Tanggal Lahir", phone: "Nomor HP", address: "Alamat Rumah", joinDate: "Bergabung Sejak", active: "Status Akun",
                memberId: "ID Peminjam", memberName: "Nama Peminjam", bookTitle: "Buku", status: "Status Pinjam", date: "Tanggal Pinjam", returnDate: "Tgl Wajib Kembali", cond: "Kondisi Awal"
            };

            const content = `<div class="space-y-3 text-sm">
                ${d.photo ? `<div class="flex justify-center mb-4"><img src="${d.photo}" class="w-32 h-32 object-cover rounded-full border-4 border-slate-100 shadow-sm"></div>` : ''}
                ${Object.entries(d).filter(([k]) => k !== 'photo' && k !== 'createdBy').map(([k, v]) => `
                    <div class="flex justify-between items-center border-b border-slate-50 pb-2">
                        <span class="text-slate-400 text-xs uppercase font-bold tracking-wide">${labels[k] || k}</span>
                        <span class="font-bold text-slate-700 text-right max-w-[60%] break-words">${v === true ? 'Aktif' : v === false ? 'Nonaktif' : v}</span>
                    </div>
                `).join('')}
                <button onclick="closeModal()" class="w-full mt-4 bg-slate-100 text-slate-600 py-3 rounded-xl font-bold">Tutup</button>
            </div>`;
            
            openModal('Detail Data', content);
        }

        // --- PRINTING SYSTEM UPDATED ---
        function printToArea(html) {
            const a = document.getElementById('printArea');
            a.innerHTML = html;
            setTimeout(() => {
                window.print();
            }, 500); 
        }

        function printCardNew(id) {
            const m = members.find(x => x.id === id);
            printToArea(`
                <div style="width:85.6mm;height:53.98mm;border:1px solid #000;border-radius:8px;overflow:hidden;position:relative;font-family:sans-serif;background:white;-webkit-print-color-adjust:exact;">
                    <div style="background:linear-gradient(135deg,#059669,#047857);height:15mm;display:flex;align-items:center;padding:0 5mm;color:white;">
                        <div style="font-size:24px;margin-right:3mm;">üìö</div>
                        <div>
                            <div style="font-weight:800;font-size:14px;line-height:1;">TBM Anak Bangsa</div>
                            <div style="font-size:8px;opacity:0.9;">Kabupaten Kepulauan Anambas</div>
                        </div>
                    </div>
                    <div style="padding:4mm;display:flex;gap:4mm;">
                        <div style="width:22mm;height:28mm;background:#f0f0f0;border:1px solid #ddd;overflow:hidden;">
                             ${m.photo ? `<img src="${m.photo}" style="width:100%;height:100%;object-fit:cover;">` : '<div style="display:flex;align-items:center;justify-content:center;height:100%;font-size:30px;color:#ccc;">üë§</div>'}
                        </div>
                        <div style="font-size:10px;line-height:1.4;flex:1;">
                            <div style="font-size:14px;font-weight:bold;color:#333;margin-bottom:2px;text-transform:uppercase;">${m.name}</div>
                            <div style="font-family:monospace;background:#eee;display:inline-block;padding:1px 4px;border-radius:3px;margin-bottom:4px;font-weight:bold;">${m.id}</div>
                            <div style="color:#555;font-size:9px;">
                                <div>Tipe: ${m.type}</div>
                                <div>${m.address.substring(0, 40)}${m.address.length>40?'...':''}</div>
                            </div>
                        </div>
                    </div>
                    <div style="position:absolute;bottom:2mm;right:4mm;font-size:7px;color:#888;text-align:right;">
                        <div>Berlaku selama menjadi anggota</div>
                        <div>TBM Anak Bangsa</div>
                    </div>
                </div>
            `);
        }

        function printDetail(id) {
            const l = loans.find(x => x.id === id);
            printToArea(`
                <div style="width:76mm;padding:5px;font-family:'Courier New', monospace;font-size:12px;color:black;">
                    <center>
                        <b style="font-size:16px">TBM Anak Bangsa</b><br>
                        Kab. Kepulauan Anambas<br>
                        --------------------------------
                    </center>
                    <table style="width:100%; font-size:12px;">
                        <tr><td>Tgl</td><td>: ${l.date}</td></tr>
                        <tr><td>ID Trx</td><td>: #${l.id}</td></tr>
                        <tr><td>Nama</td><td>: ${l.memberName.substring(0,15)}</td></tr>
                    </table>
                    --------------------------------
                    <div style="margin:5px 0;font-weight:bold;">
                        ${l.bookTitle}
                    </div>
                    <div style="font-size:11px;">
                        Kode Buku: ${l.bookId}<br>
                        Status: ${l.status.toUpperCase()}
                    </div>
                    --------------------------------
                    <div style="text-align:center;margin-top:10px;">
                        Wajib Kembali: <b>${l.returnDate}</b>
                        <br><br>
                        ~ Simpan struk ini ~
                    </div>
                </div>
            `);
        }

        function printRecapNew(type, s, e) {
            let t = '', h = '', r = '', l = [];
            const now = new Date().toLocaleDateString('id-ID');

            if (type === 'visitor') {
                l = visitors; if (s && e) l = l.filter(i => i.date >= s && i.date <= e);
                t = 'LAPORAN PENGUNJUNG';
                h = '<th>No</th><th>Tanggal</th><th>Nama Lengkap</th><th>Pekerjaan</th><th>Keperluan</th>';
                r = l.map((v, i) => `<tr><td style="text-align:center">${i + 1}</td><td>${v.date}</td><td>${v.name}</td><td>${v.job || v.category}</td><td>${v.purpose}</td></tr>`).join('');
            } else if (type === 'peminjaman') {
                l = loans; if (s && e) l = l.filter(i => i.date >= s && i.date <= e);
                t = 'LAPORAN SIRKULASI';
                h = '<th>No</th><th>Tgl Pinjam</th><th>Tgl Kembali</th><th>Peminjam</th><th>Judul Buku</th><th>Status</th>';
                r = l.map((x, i) => `<tr><td style="text-align:center">${i + 1}</td><td>${x.date}</td><td>${x.returnDate}</td><td>${x.memberName}</td><td>${x.bookTitle}</td><td style="text-align:center">${x.status}</td></tr>`).join('');
            } else if (type === 'anggota') {
                l = members;
                t = 'DATA INDUK ANGGOTA';
                h = '<th>No</th><th>ID Anggota</th><th>Nama Lengkap</th><th>TTL</th><th>Alamat</th><th>Tipe</th>';
                r = l.map((m, i) => `<tr><td style="text-align:center">${i + 1}</td><td>${m.id}</td><td>${m.name}</td><td>${m.birthPlace}, ${m.birthDate}</td><td>${m.address}</td><td>${m.type}</td></tr>`).join('');
            } else if (type === 'buku') {
                l = books;
                t = 'LAPORAN STOK BUKU';
                h = '<th>No</th><th>ISBN</th><th>Judul Buku</th><th>Penulis</th><th>Rak</th><th>Stok</th>';
                r = l.map((b, i) => `<tr><td style="text-align:center">${i + 1}</td><td>${b.isbn}</td><td>${b.title}</td><td>${b.author}</td><td style="text-align:center">${b.shelf}</td><td style="text-align:center">${b.stock}</td></tr>`).join('');
            }

            printToArea(`
                <div style="font-family:sans-serif; color:#000; padding:20px;">
                    <h2 style="text-align:center;margin-bottom:5px;text-transform:uppercase;">TBM Anak Bangsa</h2>
                    <p style="text-align:center;margin-top:0;font-size:12px;margin-bottom:15px;">Kabupaten Kepulauan Anambas</p>
                    <h4 style="text-align:center;margin-top:0;text-decoration:underline;margin-bottom:20px;">${t}</h4>
                    ${s ? `<p style="text-align:center;font-size:12px;margin-bottom:10px;">Periode Laporan: ${s} s/d ${e}</p>` : ''}
                    <table border="1" cellpadding="8" cellspacing="0" style="width:100%;border-collapse:collapse;font-size:12px;">
                        <thead><tr style="background:#f3f3f3;">${h}</tr></thead>
                        <tbody>${r}</tbody>
                    </table>
                    <div style="margin-top:40px;text-align:right;font-size:12px;">
                        <p>Dicetak pada: ${now}<br><br><br><br>( Pengelola TBM )</p>
                    </div>
                </div>
            `);
        }

        function printRecapSirkulasiCustom(type) {
            const s = document.getElementById('repStart').value;
            const e = document.getElementById('repEnd').value;
            if (!s || !e) return alert("Harap pilih tanggal 'Dari' dan 'Sampai' terlebih dahulu pada form di atas.");
            printRecapNew(type, s, e);
        }

        // INIT APP
        render();
    </script>
</body>
</html>


