<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>TBM Anak Bangsa - Kab. Kepulauan Anambas</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Plus+Jakarta+Sans:wght@400;500;600;700;800&display=swap" rel="stylesheet">
    <style>
        body { 
            font-family: 'Plus Jakarta Sans', sans-serif; 
            background-color: #f1f5f9; 
            -webkit-tap-highlight-color: transparent;
            overflow: hidden; /* Mencegah scroll pada body utama untuk layout admin */
        }
        
        /* Animations */
        .fade-in { animation: fadeIn 0.4s ease-out forwards; opacity: 0; transform: translateY(10px); }
        @keyframes fadeIn { to { opacity: 1; transform: translateY(0); } }
        
        /* Custom Scrollbar */
        .custom-scrollbar::-webkit-scrollbar { width: 5px; height: 5px; }
        .custom-scrollbar::-webkit-scrollbar-track { background: transparent; }
        .custom-scrollbar::-webkit-scrollbar-thumb { background: #cbd5e1; border-radius: 10px; }
        .custom-scrollbar::-webkit-scrollbar-thumb:hover { background: #94a3b8; }
        
        .no-scrollbar::-webkit-scrollbar { display: none; }
        .no-scrollbar { -ms-overflow-style: none; scrollbar-width: none; }

        /* Visual Elements */
        .curved-header { 
            background: linear-gradient(135deg, #059669 0%, #047857 100%); 
            border-bottom-left-radius: 30px; 
            border-bottom-right-radius: 30px; 
            padding-bottom: 60px; 
            box-shadow: 0 15px 30px -10px rgba(5, 150, 105, 0.3); 
            position: relative;
            overflow: hidden;
        }
        
        .input-field { 
            width: 100%; padding: 12px 16px; border-radius: 12px; 
            border: 1px solid #e2e8f0; background: #f8fafc; 
            outline: none; transition: all 0.2s; font-size: 14px; 
            color: #334155;
        }
        .input-field:focus { 
            border-color: #059669; background: white; 
            box-shadow: 0 0 0 3px rgba(16, 185, 129, 0.1); 
        }

        /* Charts CSS */
        .donut-chart { 
            position: relative; width: 70px; height: 70px; border-radius: 50%; 
            background: conic-gradient(var(--color) var(--percent), #e2e8f0 0); 
            display: flex; align-items: center; justify-content: center; 
        }
        .donut-inner { 
            width: 56px; height: 56px; background: white; border-radius: 50%; 
            display: flex; flex-direction: column; align-items: center; 
            justify-content: center; font-weight: 800; font-size: 14px; color: #334155; 
        }

        /* Toast Notification */
        #toast-container { position: fixed; top: 20px; left: 50%; transform: translateX(-50%); z-index: 10000; display: flex; flex-direction: column; gap: 10px; width: 90%; max-width: 400px; pointer-events: none; }
        .toast { background: white; padding: 12px 16px; border-radius: 12px; box-shadow: 0 10px 25px -5px rgba(0,0,0,0.1); display: flex; items-center; gap: 10px; animation: toastIn 0.3s cubic-bezier(0.16, 1, 0.3, 1); pointer-events: auto; border-left: 4px solid; }
        .toast.success { border-left-color: #10b981; }
        .toast.error { border-left-color: #ef4444; }
        .toast.info { border-left-color: #3b82f6; }
        @keyframes toastIn { from { opacity: 0; transform: translateY(-20px); } to { opacity: 1; transform: translateY(0); } }
        @keyframes toastOut { to { opacity: 0; transform: translateY(-20px); } }

        /* Print CSS */
        @media print { 
            body > *:not(#printArea) { display: none !important; }
            #printArea { display: block !important; position: absolute; left: 0; top: 0; width: 100%; margin: 0; padding: 0; background: white; z-index: 9999; }
            #printArea table { width: 100%; border-collapse: collapse; }
            #printArea th, #printArea td { border: 1px solid #000; padding: 8px; }
            * { -webkit-print-color-adjust: exact !important; print-color-adjust: exact !important; } 
            @page { margin: 1cm; size: auto; }
        }
    </style>
</head>
<body class="text-slate-800 h-screen w-full flex flex-col bg-slate-100">

    <!-- TOAST CONTAINER -->
    <div id="toast-container"></div>

    <!-- MAIN APP CONTAINER -->
    <div id="app" class="flex-1 flex flex-col w-full h-full overflow-hidden"></div>

    <!-- GENERAL MODAL -->
    <div id="modalOverlay" class="fixed inset-0 bg-slate-900/70 backdrop-blur-sm hidden items-center justify-center z-50 p-4 transition-opacity duration-300">
        <div class="bg-white w-full max-w-lg rounded-3xl shadow-2xl overflow-hidden transform transition-all scale-100 flex flex-col max-h-[90vh] fade-in">
            <div class="p-5 border-b border-slate-100 flex justify-between items-center bg-white sticky top-0 z-10">
                <h3 id="modalTitle" class="font-bold text-lg text-slate-800 tracking-tight">Judul Modal</h3>
                <button onclick="closeModal()" class="w-8 h-8 rounded-full bg-slate-50 text-slate-400 flex items-center justify-center hover:bg-red-50 hover:text-red-500 transition font-bold text-lg">&times;</button>
            </div>
            <div id="modalContent" class="p-6 overflow-y-auto custom-scrollbar bg-white"></div>
        </div>
    </div>

    <!-- CONFIRMATION MODAL -->
    <div id="confirmOverlay" class="fixed inset-0 bg-slate-900/80 backdrop-blur-sm hidden items-center justify-center z-[60] p-6">
        <div class="bg-white w-full max-w-xs rounded-3xl shadow-2xl p-6 fade-in text-center">
            <div class="w-12 h-12 bg-orange-100 text-orange-500 rounded-full flex items-center justify-center mx-auto mb-4 text-2xl">‚ö†Ô∏è</div>
            <h3 class="font-bold text-lg text-slate-800 mb-2">Konfirmasi</h3>
            <p id="confirmMessage" class="text-slate-500 text-sm mb-6">Apakah Anda yakin ingin melanjutkan?</p>
            <div class="flex gap-3">
                <button onclick="closeConfirm(false)" class="flex-1 py-2.5 rounded-xl bg-slate-100 text-slate-600 font-bold text-sm">Batal</button>
                <button id="confirmYesBtn" onclick="closeConfirm(true)" class="flex-1 py-2.5 rounded-xl bg-orange-500 text-white font-bold text-sm shadow-lg shadow-orange-200">Ya, Yakin</button>
            </div>
        </div>
    </div>

    <!-- PRINT AREA -->
    <div id="printArea" class="hidden bg-white text-black"></div>

    <script>
        /**
         * ------------------------------------------------------------------
         * CONFIG & STATE
         * ------------------------------------------------------------------
         */
        const DEFAULT_DATA = {
            books: [
                { id: 1, title: "Laskar Pelangi", author: "Andrea Hirata", isbn: "978-979-3062-79-2", category: "Novel", stock: 5, shelf: "A-01", createdBy: 'admin' },
                { id: 2, title: "Bumi Manusia", author: "Pramoedya A. Toer", isbn: "978-979-97312-3-4", category: "Sastra", stock: 3, shelf: "A-02", createdBy: 'admin' },
                { id: 3, title: "Atomic Habits", author: "James Clear", isbn: "978-073-5211-29-2", category: "Self-Help", stock: 4, shelf: "B-01", createdBy: 'admin' },
                { id: 4, title: "Filosofi Teras", author: "Henry Manampiring", isbn: "978-602-412-518-9", category: "Filsafat", stock: 7, shelf: "B-02", createdBy: 'admin' }
            ],
            members: [
                { id: "AGT-2025001", name: "Siti Aisyah", type: "Pelajar", nik: "1234567890", gender: "P", birthPlace: "Tarempa", birthDate: "2010-05-12", phone: "08123456789", address: "Jl. Hang Tuah No. 5", photo: null, active: true, createdBy: 'admin', joinDate: '2025-01-15' },
                { id: "AGT-2025002", name: "Budi Santoso", type: "Umum", nik: "0987654321", gender: "L", birthPlace: "Letung", birthDate: "1995-08-20", phone: "08987654321", address: "Jl. Imam Bonjol No. 88", photo: null, active: true, createdBy: 'admin', joinDate: '2025-02-01' }
            ],
            loans: [],
            visitors: [],
            users: [{ id: 'admin', name: "admin", role: "admin", password: "admin", active: true }]
        };

        // Init State
        let books = JSON.parse(localStorage.getItem('tbm_books')) || DEFAULT_DATA.books;
        let members = JSON.parse(localStorage.getItem('tbm_members')) || DEFAULT_DATA.members;
        let loans = JSON.parse(localStorage.getItem('tbm_loans')) || DEFAULT_DATA.loans;
        let visitors = JSON.parse(localStorage.getItem('tbm_visitors')) || DEFAULT_DATA.visitors;
        let users = JSON.parse(localStorage.getItem('tbm_users')) || DEFAULT_DATA.users;

        let currentView = 'visitor'; 
        let adminTab = 'dashboard'; 
        let currentUser = null; 
        let editId = null; 
        let editUserId = null; 
        let photoPreview = null;
        let filterStart = '', filterEnd = '', searchTerm = '', printSearch = '', catalogSearch = '';
        let pendingAction = null;

        /**
         * ------------------------------------------------------------------
         * UI UTILITIES
         * ------------------------------------------------------------------
         */
        function showToast(message, type = 'info') {
            const container = document.getElementById('toast-container');
            const toast = document.createElement('div');
            toast.className = `toast ${type}`;
            
            const icon = type === 'success' ? '‚úÖ' : type === 'error' ? '‚ùå' : '‚ÑπÔ∏è';
            
            toast.innerHTML = `
                <div class="text-lg">${icon}</div>
                <div class="font-bold text-sm text-slate-800">${message}</div>
            `;
            
            container.appendChild(toast);
            
            setTimeout(() => {
                toast.style.animation = 'toastOut 0.3s forwards';
                setTimeout(() => toast.remove(), 300);
            }, 3000);
        }

        function confirmAction(message, callback) {
            const overlay = document.getElementById('confirmOverlay');
            document.getElementById('confirmMessage').innerText = message;
            pendingAction = callback;
            overlay.classList.remove('hidden');
            overlay.classList.add('flex');
        }

        function closeConfirm(isConfirmed) {
            const overlay = document.getElementById('confirmOverlay');
            overlay.classList.add('hidden');
            overlay.classList.remove('flex');
            
            if (isConfirmed && pendingAction) {
                pendingAction();
            }
            pendingAction = null;
        }

        /**
         * ------------------------------------------------------------------
         * CORE UTILITIES
         * ------------------------------------------------------------------
         */
        function saveData() {
            localStorage.setItem('tbm_books', JSON.stringify(books));
            localStorage.setItem('tbm_members', JSON.stringify(members));
            localStorage.setItem('tbm_loans', JSON.stringify(loans));
            localStorage.setItem('tbm_visitors', JSON.stringify(visitors));
            localStorage.setItem('tbm_users', JSON.stringify(users));
            render();
        }

        function setView(v) { 
            currentView = v; 
            if(v === 'visitor') currentUser = null; 
            render(); 
        }

        function setTab(t) { 
            adminTab = t; 
            filterStart = ''; filterEnd = ''; searchTerm = ''; printSearch = ''; 
            render(); 
        }

        function login(u, p) { 
            const cleanUser = u.trim().toLowerCase(); 
            const cleanPass = p.trim(); 

            const user = users.find(x => x.name.toLowerCase() === cleanUser && x.password === cleanPass && x.active); 
            
            if(user) { 
                currentUser = user; 
                closeModal(); 
                setView('admin'); 
                setTab('dashboard'); 
                showToast(`Selamat datang, ${user.name}!`, 'success');
            } else {
                showToast('Username atau Password salah!', 'error');
            }
        }

        function requestReset() {
            confirmAction("Hapus semua data dan kembali ke default?", () => {
                localStorage.clear();
                location.reload();
            });
        }

        function canEdit(item) { 
            if(!currentUser) return false; 
            if(currentUser.role === 'admin') return true; 
            return item.createdBy === currentUser.id; 
        }

        /**
         * ------------------------------------------------------------------
         * RENDER ENGINE
         * ------------------------------------------------------------------
         */
        function render() { 
            const app = document.getElementById('app'); 
            if(currentView === 'visitor') renderVisitor(app); 
            else renderAdmin(app); 
        }

        // --- VISITOR VIEW ---
        function renderVisitor(container) {
            const tb = books.length; 
            const tm = members.filter(m => m.active).length; 
            const today = new Date().toISOString().slice(0,10);
            const tv = visitors.filter(v => v.date === today).length;

            container.innerHTML = `
                <div class="w-full h-full overflow-y-auto bg-slate-50 custom-scrollbar">
                    <div class="w-full max-w-md mx-auto bg-white shadow-2xl relative flex flex-col min-h-screen overflow-hidden">
                        <!-- Header -->
                        <div class="curved-header pt-12 px-6 text-center relative">
                            <div class="absolute top-0 left-0 w-full h-full opacity-10 bg-[url('https://www.transparenttextures.com/patterns/cubes.png')]"></div>
                            <div class="bg-white/20 backdrop-blur-md w-16 h-16 mx-auto rounded-2xl flex items-center justify-center mb-4 border border-white/30 shadow-lg">
                                <svg class="w-8 h-8 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 6.253v13m0-13C10.832 5.477 9.246 5 7.5 5S4.168 5.477 3 6.253v13C4.168 18.477 5.754 18 7.5 18s3.332.477 4.5 1.253m0-13C13.168 5.477 14.754 5 16.5 5c1.747 0 3.332.477 4.5 1.253v13C19.832 18.477 18.247 18 16.5 18c-1.746 0-3.332.477-4.5 1.253"/></svg>
                            </div>
                            <h1 class="text-2xl font-extrabold text-white tracking-tight drop-shadow-sm uppercase">TBM Anak Bangsa</h1>
                            <p class="text-emerald-100 text-sm font-medium mt-1 opacity-90">Kab. Kepulauan Anambas</p>
                            
                            <button onclick="openLoginModal()" class="absolute top-6 right-6 bg-white/10 hover:bg-white/20 p-2 rounded-xl text-white transition backdrop-blur-md border border-white/20">
                                <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M11 16l-4-4m0 0l4-4m-4 4h14m-5 4v1a3 3 0 01-3 3H6a3 3 0 01-3-3V7a3 3 0 013-3h7a3 3 0 013 3v1"/></svg>
                            </button>
                        </div>

                        <!-- Main Content -->
                        <div class="px-6 -mt-10 relative z-10 space-y-5 fade-in pb-10">
                            <!-- Stats Card -->
                            <div class="bg-white rounded-3xl p-6 shadow-xl border border-slate-100 flex justify-between items-center">
                                <div class="flex flex-col items-center group cursor-pointer">
                                    <div class="donut-chart group-hover:scale-105 transition-transform" style="--color: #3b82f6; --percent: 75%;">
                                        <div class="donut-inner text-blue-600">${tb}</div>
                                    </div>
                                    <span class="text-[10px] font-bold text-slate-400 mt-2 uppercase tracking-wider">Koleksi</span>
                                </div>
                                <div class="w-px h-10 bg-slate-100"></div>
                                <div class="flex flex-col items-center group cursor-pointer">
                                    <div class="donut-chart group-hover:scale-105 transition-transform" style="--color: #a855f7; --percent: 60%;">
                                        <div class="donut-inner text-purple-600">${tm}</div>
                                    </div>
                                    <span class="text-[10px] font-bold text-slate-400 mt-2 uppercase tracking-wider">Anggota</span>
                                </div>
                                <div class="w-px h-10 bg-slate-100"></div>
                                <div class="flex flex-col items-center group cursor-pointer">
                                    <div class="donut-chart group-hover:scale-105 transition-transform" style="--color: #f97316; --percent: ${Math.min(tv*10,100)}%;">
                                        <div class="donut-inner text-orange-600">${tv}</div>
                                    </div>
                                    <span class="text-[10px] font-bold text-slate-400 mt-2 uppercase tracking-wider">Tamu</span>
                                </div>
                            </div>

                            <!-- Menu Buttons -->
                            <button onclick="openVisitorForm()" class="w-full bg-white p-4 rounded-3xl shadow-md border border-slate-50 flex items-center gap-4 hover:shadow-lg hover:border-orange-100 transition-all active:scale-[0.98] group relative overflow-hidden">
                                <div class="absolute inset-0 bg-orange-50 transform -translate-x-full group-hover:translate-x-0 transition-transform duration-500"></div>
                                <div class="w-12 h-12 bg-orange-100 text-orange-600 rounded-2xl flex items-center justify-center shadow-sm relative z-10 group-hover:scale-110 transition-transform">
                                    <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15.232 5.232l3.536 3.536m-2.036-5.036a2.5 2.5 0 113.536 3.536L6.5 21.036H3v-3.572L16.732 3.732z"/></svg>
                                </div>
                                <div class="text-left relative z-10">
                                    <h3 class="font-bold text-lg text-slate-800 group-hover:text-orange-700 transition-colors">Buku Tamu</h3>
                                    <p class="text-slate-500 text-xs">Isi kehadiran pengunjung</p>
                                </div>
                            </button>

                            <button onclick="openCatalog()" class="w-full bg-white p-4 rounded-3xl shadow-md border border-slate-50 flex items-center gap-4 hover:shadow-lg hover:border-blue-100 transition-all active:scale-[0.98] group relative overflow-hidden">
                                <div class="absolute inset-0 bg-blue-50 transform -translate-x-full group-hover:translate-x-0 transition-transform duration-500"></div>
                                <div class="w-12 h-12 bg-blue-100 text-blue-600 rounded-2xl flex items-center justify-center shadow-sm relative z-10 group-hover:scale-110 transition-transform">
                                    <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z"/></svg>
                                </div>
                                <div class="text-left relative z-10">
                                    <h3 class="font-bold text-lg text-slate-800 group-hover:text-blue-700 transition-colors">Cari Buku</h3>
                                    <p class="text-slate-500 text-xs">Lihat stok & lokasi buku</p>
                                </div>
                            </button>

                            <div class="text-center mt-8">
                                <p class="text-[10px] text-slate-400 font-medium">¬© 2025 TBM Anak Bangsa</p>
                            </div>
                        </div>
                    </div>
                </div>`;
        }

        // --- ADMIN VIEW (FIXED LAYOUT) ---
        function renderAdmin(container) {
            const isAdmin = currentUser && currentUser.role === 'admin';
            
            let content = `
            <div class="flex h-full w-full bg-slate-100 overflow-hidden">
                <!-- Sidebar (Desktop) - Fixed Width, Full Height -->
                <div class="hidden md:flex flex-col w-64 bg-slate-900 text-white h-full flex-shrink-0 shadow-2xl relative z-30">
                    <div class="p-6 border-b border-slate-800 flex flex-col items-center">
                        <div class="w-12 h-12 bg-emerald-500 rounded-xl flex items-center justify-center text-2xl mb-3 shadow-lg">üìö</div>
                        <div class="font-bold text-lg tracking-wide text-center leading-tight">TBM Anak Bangsa</div>
                        <div class="text-[10px] text-slate-400 mt-1">Anambas</div>
                        <div class="text-[10px] text-emerald-300 mt-2 bg-slate-800 px-3 py-1 rounded-full uppercase font-bold">${currentUser.role}</div>
                    </div>
                    <nav class="flex-1 p-4 space-y-2 overflow-y-auto custom-scrollbar">
                        ${renderSidebar('dashboard','Dashboard', 'M4 6a2 2 0 012-2h2a2 2 0 012 2v2a2 2 0 01-2 2H6a2 2 0 01-2-2V6zM14 6a2 2 0 012-2h2a2 2 0 012 2v2a2 2 0 01-2 2h-2a2 2 0 01-2-2V6zM4 16a2 2 0 012-2h2a2 2 0 012 2v2a2 2 0 01-2 2H6a2 2 0 01-2-2v-2zM14 16a2 2 0 012-2h2a2 2 0 012 2v2a2 2 0 01-2 2h-2a2 2 0 01-2-2v-2z')}
                        ${renderSidebar('anggota','Anggota', 'M12 4.354a4 4 0 110 5.292M15 21H3v-1a6 6 0 0112 0v1zm0 0h6v-1a6 6 0 00-9-5.197M13 7a4 4 0 11-8 0 4 4 0 018 0z')}
                        ${renderSidebar('buku','Buku', 'M12 6.253v13m0-13C10.832 5.477 9.246 5 7.5 5S4.168 5.477 3 6.253v13C4.168 18.477 5.754 18 7.5 18s3.332.477 4.5 1.253m0-13C13.168 5.477 14.754 5 16.5 5c1.747 0 3.332.477 4.5 1.253v13C19.832 18.477 18.247 18 16.5 18c-1.746 0-3.332.477-4.5 1.253')}
                        ${renderSidebar('peminjaman','Sirkulasi', 'M8 7h12m0 0l-4-4m4 4l-4 4m0 6H4m0 0l4 4m-4-4l4-4')}
                        ${isAdmin ? renderSidebar('laporan','Laporan', 'M9 17v-2m3 2v-4m3 4v-6m2 10H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z') : ''}
                        ${isAdmin ? renderSidebar('pengaturan','Pengaturan', 'M10.325 4.317c.426-1.756 2.924-1.756 3.35 0a1.724 1.724 0 002.573 1.066c1.543-.94 3.31.826 2.37 2.37a1.724 1.724 0 001.065 2.572c1.756.426 1.756 2.924 0 3.35a1.724 1.724 0 00-1.066 2.573c.94 1.543-.826 3.31-2.37 2.37a1.724 1.724 0 00-2.572 1.065c-.426 1.756-2.924 1.756-3.35 0a1.724 1.724 0 00-2.573-1.066c-1.543.94-3.31-.826-2.37-2.37a1.724 1.724 0 00-1.065-2.572c-1.756-.426-1.756-2.924 0-3.35a1.724 1.724 0 001.066-2.573c-.94-1.543.826-3.31 2.37-2.37.996.608 2.296.07 2.572-1.065z M15 12a3 3 0 11-6 0 3 3 0 016 0z') : ''}
                    </nav>
                    <div class="p-4 border-t border-slate-800">
                        <button onclick="setView('visitor')" class="w-full bg-red-500/10 hover:bg-red-600 text-red-400 hover:text-white py-3 rounded-xl font-bold transition flex items-center justify-center gap-2 text-sm">
                           <span>üö™</span> Keluar
                        </button>
                    </div>
                </div>

                <!-- Content Wrapper (Flex Grow) - Handles scrolling internally -->
                <div class="flex-1 flex flex-col h-full relative overflow-hidden w-full">
                    
                    <!-- Mobile Header -->
                    <div class="md:hidden bg-white px-4 py-3 shadow-sm flex justify-between items-center shrink-0 z-20 border-b border-slate-200">
                        <div class="flex items-center gap-2">
                            <div class="w-8 h-8 bg-emerald-500 rounded-lg flex items-center justify-center text-white font-bold text-sm">T</div>
                            <div class="font-bold text-base text-slate-800 truncate max-w-[150px]">Panel Admin</div>
                        </div>
                        <button onclick="setView('visitor')" class="text-[10px] bg-red-50 text-red-500 px-3 py-1.5 rounded-lg font-bold border border-red-100">Keluar</button>
                    </div>

                    <!-- Mobile Tabs -->
                    <div class="md:hidden bg-white border-b border-slate-200 overflow-x-auto flex gap-2 p-2 shrink-0 z-10 no-scrollbar">
                        ${renderMTab('dashboard')}
                        ${renderMTab('anggota')}
                        ${renderMTab('buku')}
                        ${renderMTab('peminjaman')}
                        ${isAdmin ? renderMTab('laporan') : ''}
                        ${isAdmin ? renderMTab('pengaturan') : ''}
                    </div>

                    <!-- SCROLLABLE CONTENT AREA -->
                    <div class="flex-1 overflow-y-auto p-4 md:p-8 w-full custom-scrollbar pb-24 md:pb-8">
                        <div class="max-w-6xl mx-auto w-full">`;

            // --- CONTENT LOGIC ---
            if(adminTab==='dashboard') {
                content += `
                    <div class="bg-gradient-to-br from-emerald-600 to-teal-700 rounded-3xl p-6 md:p-8 text-white shadow-xl mb-6 relative overflow-hidden w-full">
                        <div class="absolute top-0 right-0 w-48 h-48 bg-white/10 rounded-full -mr-10 -mt-10 blur-3xl"></div>
                        <div class="relative z-10">
                            <h2 class="text-2xl md:text-3xl font-bold mb-2">Halo, ${currentUser.name}!</h2>
                            <p class="opacity-90 text-xs md:text-sm">Selamat datang di Panel Administrasi TBM Anak Bangsa.</p>
                        </div>
                    </div>
                    <div class="grid grid-cols-2 lg:grid-cols-4 gap-3 md:gap-6 w-full">
                        ${renderStat('Buku', books.length, 'blue', 'üìö')}
                        ${renderStat('Anggota', members.length, 'purple', 'üë•')}
                        ${renderStat('Dipinjam', loans.filter(l => l.status === 'Dipinjam').length, 'orange', '‚è≥')}
                        ${renderStat('Tamu', visitors.length, 'emerald', 'üìù')}
                    </div>`;
            }
            else if(['anggota','buku','peminjaman'].includes(adminTab)) {
                content += `
                    <div class="bg-white p-4 rounded-2xl shadow-sm mb-4 border border-slate-200 flex flex-col gap-3 sticky top-0 z-10">
                        <div class="relative w-full">
                            <span class="absolute left-3 top-1/2 -translate-y-1/2 text-slate-400 text-sm">üîç</span>
                            <input type="text" placeholder="Cari data..." class="input-field pl-9" value="${searchTerm}" oninput="searchTerm=this.value; render()">
                        </div>
                        ${adminTab === 'peminjaman' ? `
                        <div class="grid grid-cols-2 gap-2 w-full">
                            <input type="date" class="input-field text-xs" value="${filterStart}" onchange="filterStart=this.value; render()">
                            <input type="date" class="input-field text-xs" value="${filterEnd}" onchange="filterEnd=this.value; render()">
                        </div>` : ''}
                        <div class="flex gap-2 w-full">
                            ${isAdmin ? `<button onclick="printRecapNew('${adminTab}')" class="bg-slate-800 text-white px-4 py-2 rounded-xl font-bold text-xs flex-1 shadow hover:bg-slate-700">Cetak</button>` : ''}
                            <button onclick="${adminTab==='anggota'?'modalAnggota()':adminTab==='buku'?'modalBuku()':'modalPinjam()'}" class="bg-emerald-600 text-white px-4 py-2 rounded-xl font-bold text-xs flex-1 shadow hover:bg-emerald-700">Tambah</button>
                        </div>
                    </div>`;

                if(adminTab==='anggota') {
                    const filtered = members.filter(m => m.name.toLowerCase().includes(searchTerm.toLowerCase()) || m.id.includes(searchTerm));
                    content += `<div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-3 w-full">${filtered.length ? filtered.map(m => renderMemberCard(m)).join('') : '<div class="col-span-full text-center py-10 text-slate-400 text-sm">Data tidak ditemukan</div>'}</div>`;
                } else if(adminTab==='buku') {
                    const filtered = books.filter(b => b.title.toLowerCase().includes(searchTerm.toLowerCase()) || b.author.toLowerCase().includes(searchTerm.toLowerCase()));
                    content += `<div class="grid grid-cols-1 md:grid-cols-2 gap-3 w-full">${filtered.length ? filtered.map(b => renderBookCard(b)).join('') : '<div class="col-span-full text-center py-10 text-slate-400 text-sm">Data tidak ditemukan</div>'}</div>`;
                } else {
                    let f = loans.filter(l => l.bookTitle.toLowerCase().includes(searchTerm.toLowerCase()) || l.memberName.toLowerCase().includes(searchTerm.toLowerCase()));
                    if(filterStart && filterEnd) f = f.filter(l => l.date >= filterStart && l.date <= filterEnd);
                    content += `<div class="space-y-3 w-full">${f.length === 0 ? '<div class="text-center text-slate-400 py-10 text-sm border-2 border-dashed border-slate-200 rounded-xl">Tidak ada data.</div>' : ''}${f.slice().reverse().map(l => renderLoanCard(l)).join('')}</div>`;
                }
            }
            else if(adminTab==='laporan' && isAdmin) {
                content += `
                <div class="grid grid-cols-1 gap-4 w-full">
                    <div class="bg-white p-5 rounded-2xl shadow-sm border border-slate-200 w-full">
                        <h3 class="font-bold text-lg text-slate-800 mb-4 flex items-center gap-2"><span class="text-blue-600">üìä</span> Laporan</h3>
                        <div class="grid grid-cols-2 gap-2 mb-4">
                            <input type="date" id="repStart" class="input-field text-xs">
                            <input type="date" id="repEnd" class="input-field text-xs">
                        </div>
                        <div class="space-y-2">
                            <button onclick="printRecapNew('anggota')" class="w-full text-left p-3 border rounded-xl text-sm font-bold hover:bg-slate-50 flex justify-between"><span>Data Anggota</span> <span>üñ®Ô∏è</span></button>
                            <button onclick="printRecapNew('buku')" class="w-full text-left p-3 border rounded-xl text-sm font-bold hover:bg-slate-50 flex justify-between"><span>Stok Buku</span> <span>üñ®Ô∏è</span></button>
                            <button onclick="printRecapSirkulasiCustom('peminjaman')" class="w-full text-left p-3 border border-orange-200 bg-orange-50 rounded-xl text-sm font-bold flex justify-between text-orange-700"><span>Sirkulasi</span> <span>üñ®Ô∏è</span></button>
                            <button onclick="printRecapSirkulasiCustom('visitor')" class="w-full text-left p-3 border border-purple-200 bg-purple-50 rounded-xl text-sm font-bold flex justify-between text-purple-700"><span>Buku Tamu</span> <span>üñ®Ô∏è</span></button>
                        </div>
                    </div>

                    <div class="bg-white p-5 rounded-2xl shadow-sm border border-slate-200 w-full">
                        <h3 class="font-bold text-lg text-slate-800 mb-4 flex items-center gap-2"><span class="text-emerald-600">üÜî</span> Cetak Kartu</h3>
                        <input type="text" placeholder="Cari nama..." class="input-field mb-3 text-sm" value="${printSearch}" oninput="printSearch=this.value; render()">
                        <div class="space-y-2 max-h-[300px] overflow-y-auto custom-scrollbar">
                            ${members.filter(m => m.name.toLowerCase().includes(printSearch.toLowerCase())).map(m => `
                                <div class="flex items-center justify-between p-3 border rounded-xl">
                                    <div class="text-sm font-bold text-slate-700 truncate max-w-[150px]">${m.name}</div>
                                    <button onclick="printCardNew('${m.id}')" class="text-xs bg-emerald-100 text-emerald-700 px-3 py-1.5 rounded-lg font-bold">Cetak</button>
                                </div>`).join('')}
                        </div>
                    </div>
                </div>`;
            }
            else if(adminTab==='pengaturan' && isAdmin) {
                content += `
                <div class="grid grid-cols-1 gap-4 w-full">
                    <div class="bg-white p-5 rounded-2xl shadow-sm border border-slate-200 w-full">
                        <div class="flex justify-between items-center mb-4">
                            <h3 class="font-bold text-lg text-slate-800">Petugas</h3>
                            <button onclick="modalUser()" class="bg-slate-800 text-white px-3 py-1.5 rounded-lg text-xs font-bold">+ Baru</button>
                        </div>
                        <div class="space-y-2">
                            ${users.map(u => `
                                <div class="flex items-center justify-between p-3 border rounded-xl bg-slate-50">
                                    <div><div class="font-bold text-sm">${u.name}</div><div class="text-[10px] uppercase text-slate-500">${u.role}</div></div>
                                    ${u.role !== 'admin' ? `<button onclick="deleteUser('${u.id}')" class="text-red-500 font-bold px-2">‚úï</button>` : ''}
                                </div>`).join('')}
                        </div>
                    </div>
                    <div class="bg-white p-5 rounded-2xl shadow-sm border border-slate-200 w-full">
                        <h3 class="font-bold text-lg text-slate-800 mb-2">Reset</h3>
                        <button onclick="requestReset()" class="w-full border border-red-200 text-red-500 bg-red-50 py-2 rounded-xl font-bold text-sm">Reset Aplikasi</button>
                    </div>
                </div>`;
            }

            content += `</div></div></div></div>`; 
            container.innerHTML = content;
        }

        // --- COMPONENT HELPERS ---
        function renderSidebar(id, label, iconPath) {
            const active = adminTab === id;
            return `<button onclick="setTab('${id}')" class="w-full text-left px-4 py-3 rounded-xl transition-all flex items-center gap-3 ${active ? 'bg-emerald-600 text-white font-semibold shadow-md' : 'text-slate-400 hover:bg-slate-800 hover:text-emerald-400'}">
                <svg class="w-5 h-5 flex-shrink-0" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="${iconPath}"/></svg>
                <span class="truncate">${label}</span>
            </button>`;
        }
        function renderMTab(id) {
            let lbl = id === 'laporan' ? 'Laporan' : id.charAt(0).toUpperCase() + id.slice(1);
            const active = adminTab === id;
            return `<button onclick="setTab('${id}')" class="px-4 py-1.5 rounded-full text-[11px] font-bold whitespace-nowrap transition-colors ${active ? 'bg-emerald-600 text-white shadow' : 'bg-slate-100 text-slate-500 border border-slate-200'}">${lbl}</button>`;
        }
        function renderStat(l, v, c, icon) {
            const colors = {
                blue: 'text-blue-600 bg-blue-50 border-blue-100',
                purple: 'text-purple-600 bg-purple-50 border-purple-100',
                orange: 'text-orange-600 bg-orange-50 border-orange-100',
                emerald: 'text-emerald-600 bg-emerald-50 border-emerald-100'
            };
            return `<div class="p-4 rounded-2xl border shadow-sm ${colors[c]} flex flex-col justify-between h-24 relative overflow-hidden w-full">
                <div class="absolute right-0 top-0 p-2 opacity-10 text-5xl">${icon}</div>
                <div class="text-2xl font-extrabold relative z-10">${v}</div>
                <div class="text-[10px] font-bold uppercase tracking-wider opacity-70 relative z-10">${l}</div>
            </div>`;
        }
        function renderMemberCard(m) {
            const showEdit = canEdit(m);
            return `
            <div class="bg-white p-4 rounded-2xl border border-slate-200 shadow-sm relative w-full">
                <div class="flex items-center gap-3 mb-3">
                    <div class="w-10 h-10 bg-slate-100 rounded-full overflow-hidden border border-slate-200 flex-shrink-0">
                        ${m.photo ? `<img src="${m.photo}" class="w-full h-full object-cover">` : `<div class="w-full h-full flex items-center justify-center text-slate-400 font-bold">${m.name[0]}</div>`}
                    </div>
                    <div class="min-w-0 flex-1 overflow-hidden">
                        <h4 class="font-bold text-sm text-slate-800 truncate">${m.name}</h4>
                        <p class="text-[10px] font-bold text-slate-500 bg-slate-100 px-2 rounded inline-block uppercase">${m.type}</p>
                    </div>
                </div>
                <div class="text-[11px] text-slate-500 mb-3 flex justify-between items-center">
                    <span class="font-mono bg-slate-50 px-1 rounded">${m.id}</span> 
                    <span class="${m.active?'text-emerald-600':'text-red-500'} font-bold text-[10px]">${m.active?'Aktif':'Non'}</span>
                </div>
                <div class="flex gap-2 pt-2 border-t border-slate-100">
                    <button onclick="modalDetail('anggota','${m.id}')" class="flex-1 bg-blue-50 text-blue-600 py-1.5 rounded-lg text-[10px] font-bold hover:bg-blue-100 transition">Detail</button>
                    ${showEdit ? `<button onclick="modalAnggota('${m.id}')" class="flex-1 bg-orange-50 text-orange-600 py-1.5 rounded-lg text-[10px] font-bold hover:bg-orange-100 transition">Edit</button>` : ''}
                </div>
                ${showEdit ? `<button onclick="deleteItem('m','${m.id}')" class="absolute top-2 right-2 text-slate-300 hover:text-red-500 font-bold text-xs px-2">‚úï</button>` : ''}
            </div>`;
        }
        function renderBookCard(b) {
            const showEdit = canEdit(b);
            return `
            <div class="bg-white p-4 rounded-2xl border border-slate-200 shadow-sm relative w-full">
                <h4 class="font-bold text-sm text-slate-800 line-clamp-1 pr-5">${b.title}</h4>
                <p class="text-[10px] text-slate-500 mb-2 line-clamp-1">${b.author || '-'}</p>
                <div class="flex gap-1 mb-2">
                    <span class="text-[9px] bg-slate-100 px-1.5 py-0.5 rounded text-slate-600 truncate max-w-[80px]">${b.category}</span>
                    <span class="text-[9px] bg-slate-100 px-1.5 py-0.5 rounded text-slate-600 whitespace-nowrap">Rak: ${b.shelf}</span>
                </div>
                <div class="flex justify-between items-center pt-2 border-t border-slate-100">
                    <span class="${b.stock>0?'text-emerald-700 bg-emerald-50':'text-red-700 bg-red-50'} px-2 py-0.5 rounded text-[10px] font-bold whitespace-nowrap">Stok: ${b.stock}</span>
                    <div class="flex gap-1">
                        <button onclick="modalDetail('buku', ${b.id})" class="px-2 py-1 rounded-md bg-blue-50 text-blue-600 text-[10px] font-bold hover:bg-blue-100">Lihat</button>
                        ${showEdit ? `<button onclick="modalBuku(${b.id})" class="px-2 py-1 rounded-md bg-orange-50 text-orange-600 text-[10px] font-bold hover:bg-orange-100">Edit</button>` : ''}
                    </div>
                </div>
                ${showEdit ? `<button onclick="deleteItem('b',${b.id})" class="absolute top-2 right-2 text-slate-300 hover:text-red-500 font-bold text-xs px-2">‚úï</button>` : ''}
            </div>`;
        }
        function renderLoanCard(l) {
            const showEdit = canEdit(l);
            return `
            <div class="bg-white p-4 rounded-2xl border-l-4 ${l.status === 'Dipinjam' ? 'border-orange-400' : 'border-emerald-400'} shadow-sm relative w-full">
                <div class="flex justify-between items-start mb-1">
                    <div class="text-[10px] text-slate-400">${l.date}</div>
                    <span class="px-2 py-0.5 rounded text-[9px] font-bold uppercase ${l.status==='Dipinjam'?'bg-orange-50 text-orange-600':'bg-emerald-50 text-emerald-600'}">${l.status}</span>
                </div>
                <h4 class="font-bold text-sm text-slate-800 line-clamp-1 pr-2">${l.bookTitle}</h4>
                <p class="text-[11px] text-slate-600 line-clamp-1">Peminjam: <b>${l.memberName}</b></p>
                <div class="flex gap-2 mt-3 justify-end border-t border-slate-50 pt-2">
                    <button onclick="printDetail(${l.id})" class="text-[10px] text-slate-500 bg-slate-100 px-3 py-1.5 rounded-lg font-bold hover:bg-slate-200 transition">Struk</button>
                    ${l.status === 'Dipinjam' && showEdit ? `<button onclick="kembalikanBuku(${l.id})" class="bg-emerald-600 text-white px-3 py-1.5 rounded-lg text-[10px] font-bold shadow hover:bg-emerald-700 transition">Kembali</button>` : ''}
                </div>
            </div>`;
        }

        /**
         * ------------------------------------------------------------------
         * MODAL & FORM HANDLERS
         * ------------------------------------------------------------------
         */
        const overlay = document.getElementById('modalOverlay');
        const mTitle = document.getElementById('modalTitle');
        const mContent = document.getElementById('modalContent');

        function openModal(t, h) { mTitle.innerText = t; mContent.innerHTML = h; overlay.classList.remove('hidden'); overlay.classList.add('flex'); }
        function closeModal() { overlay.classList.add('hidden'); overlay.classList.remove('flex'); photoPreview = null; editId = null; editUserId = null; }

        function openLoginModal() {
            openModal('Masuk Panel Admin', `
                <form onsubmit="processLogin(event)" class="space-y-4 pt-2">
                    <div><label class="text-[11px] font-bold text-slate-400 uppercase">Username</label><input name="u" required class="input-field mt-1" placeholder="admin" autocapitalize="off" autocomplete="off"></div>
                    <div><label class="text-[11px] font-bold text-slate-400 uppercase">Password</label><input type="password" name="p" required class="input-field mt-1" placeholder="admin"></div>
                    <div class="pt-2">
                        <button class="w-full bg-emerald-600 text-white py-3 rounded-xl font-bold hover:bg-emerald-700 shadow-lg transition">MASUK</button>
                        <div class="flex justify-between mt-3">
                            <button type="button" onclick="closeModal()" class="text-slate-400 text-xs">Batal</button>
                            <button type="button" onclick="requestReset()" class="text-red-400 text-xs font-bold">Reset Data</button>
                        </div>
                    </div>
                </form>`);
        }
        function processLogin(e) { e.preventDefault(); login(e.target.u.value, e.target.p.value); }
        
        // MANAGE USER
        function modalUser(id = null) {
            const u = id ? users.find(x => x.id === id) : {};
            editUserId = id;
            openModal(id ? 'Edit Petugas' : 'Tambah Petugas', `
                <form onsubmit="saveUser(event)" class="space-y-4">
                    <div><label class="text-[11px] font-bold text-slate-400 uppercase">Nama Petugas</label><input name="name" value="${u.name || ''}" required class="input-field mt-1" autocapitalize="off"></div>
                    <div><label class="text-[11px] font-bold text-slate-400 uppercase">Password</label><input type="text" name="password" value="${u.password || ''}" required class="input-field mt-1"></div>
                    <div class="flex gap-3 pt-2">
                        <button type="button" onclick="closeModal()" class="flex-1 bg-slate-100 text-slate-600 py-3 rounded-xl font-bold">Batal</button>
                        <button class="flex-1 bg-emerald-600 text-white py-3 rounded-xl font-bold shadow-lg">Simpan</button>
                    </div>
                </form>`);
        }
        function saveUser(e) {
            e.preventDefault();
            const n = e.target.name.value;
            const p = e.target.password.value;
            if(editUserId) users = users.map(u => u.id === editUserId ? { ...u, name: n, password: p } : u);
            else users.push({ id: 'petugas_' + Date.now(), name: n, role: 'petugas', password: p, active: true });
            saveData(); closeModal();
            showToast('Data petugas tersimpan!', 'success');
        }
        function deleteUser(id) { 
            confirmAction('Hapus petugas ini?', () => {
                users = users.filter(x => x.id !== id); 
                saveData();
                showToast('Petugas dihapus.', 'info');
            });
        }

        // ANGGOTA
        function modalAnggota(id = null) {
            const d = id ? members.find(m => m.id === id) : {};
            editId = id;
            photoPreview = d.photo || null;
            const newID = id || `AGT-${new Date().getFullYear()}${Math.floor(Math.random() * 9000) + 1000}`;
            
            openModal(id ? 'Edit Anggota' : 'Tambah Anggota', `
                <form onsubmit="handleMemberSubmit(event)" class="space-y-3">
                    <div class="flex justify-center mb-2">
                        <label class="w-20 h-20 bg-slate-50 rounded-full flex items-center justify-center border-2 border-dashed border-slate-300 cursor-pointer overflow-hidden relative">
                            <img id="preview" src="${photoPreview || ''}" class="${photoPreview ? '' : 'hidden'} w-full h-full object-cover absolute">
                            <span class="text-[10px] text-slate-400 font-bold">üì∑ Foto</span>
                            <input type="file" class="hidden" onchange="handlePhoto(this)" accept="image/*">
                        </label>
                    </div>
                    <div class="grid grid-cols-2 gap-3">
                        <div><label class="text-[10px] font-bold text-slate-400 uppercase">ID</label><input name="mid" value="${newID}" readonly class="input-field bg-slate-100 text-center font-mono font-bold text-slate-500"></div>
                        <div><label class="text-[10px] font-bold text-slate-400 uppercase">NIK</label><input name="nik" value="${d.nik || ''}" placeholder="NIK" class="input-field"></div>
                    </div>
                    <div><label class="text-[10px] font-bold text-slate-400 uppercase">Nama</label><input name="name" value="${d.name || ''}" required class="input-field"></div>
                    <div class="grid grid-cols-2 gap-3">
                        <div><label class="text-[10px] font-bold text-slate-400 uppercase">Lahir di</label><input name="bPlace" value="${d.birthPlace || ''}" class="input-field"></div>
                        <div><label class="text-[10px] font-bold text-slate-400 uppercase">Tgl Lahir</label><input name="bDate" type="date" value="${d.birthDate || ''}" class="input-field"></div>
                    </div>
                    <div class="grid grid-cols-2 gap-3">
                        <div><label class="text-[10px] font-bold text-slate-400 uppercase">Gender</label><select name="gender" class="input-field"><option value="L">Laki-laki</option><option value="P">Perempuan</option></select></div>
                        <div><label class="text-[10px] font-bold text-slate-400 uppercase">Tipe</label><select name="type" class="input-field"><option>Umum</option><option>Pelajar</option></select></div>
                    </div>
                    <div><label class="text-[10px] font-bold text-slate-400 uppercase">No HP</label><input name="phone" value="${d.phone || ''}" class="input-field"></div>
                    <div><label class="text-[10px] font-bold text-slate-400 uppercase">Alamat</label><textarea name="addr" rows="2" class="input-field">${d.address || ''}</textarea></div>
                    <div class="flex gap-3 pt-2">
                        <button type="button" onclick="closeModal()" class="flex-1 bg-slate-100 text-slate-600 py-3 rounded-xl font-bold">Batal</button>
                        <button class="flex-1 bg-emerald-600 text-white py-3 rounded-xl font-bold shadow-lg">Simpan</button>
                    </div>
                </form>`);
        }
        function handleMemberSubmit(e) {
            e.preventDefault();
            const f = e.target;
            const d = {
                id: f.mid.value, nik: f.nik.value, name: f.name.value,
                birthPlace: f.bPlace.value, birthDate: f.bDate.value, gender: f.gender.value,
                type: f.type.value, phone: f.phone.value, address: f.addr.value,
                photo: photoPreview, active: true,
                createdBy: currentUser ? currentUser.id : 'admin',
                joinDate: editId ? (members.find(m=>m.id===editId).joinDate) : new Date().toISOString().slice(0, 10)
            };
            if(editId) members = members.map(m => m.id === editId ? { ...m, ...d } : m);
            else members.push(d);
            saveData(); closeModal();
            showToast('Data anggota disimpan!', 'success');
        }

        // BUKU
        function modalBuku(id = null) {
            const d = id ? books.find(b => b.id === id) : {};
            editId = id;
            openModal(id ? 'Edit Buku' : 'Tambah Buku', `
                <form onsubmit="handleBookSubmit(event)" class="space-y-3">
                    <div><label class="text-[10px] font-bold text-slate-400 uppercase">Judul</label><input name="title" value="${d.title || ''}" required class="input-field"></div>
                    <div class="grid grid-cols-2 gap-3">
                         <div><label class="text-[10px] font-bold text-slate-400 uppercase">ISBN</label><input name="isbn" value="${d.isbn || ''}" class="input-field"></div>
                         <div><label class="text-[10px] font-bold text-slate-400 uppercase">Penulis</label><input name="author" value="${d.author || ''}" class="input-field"></div>
                    </div>
                    <div class="grid grid-cols-2 gap-2">
                        <div><label class="text-[10px] font-bold text-slate-400 uppercase">Kategori</label><input name="category" value="${d.category || ''}" class="input-field" list="catList"><datalist id="catList"><option value="Novel"><option value="Sastra"><option value="Pelajaran"><option value="Komik"></datalist></div>
                        <div><label class="text-[10px] font-bold text-slate-400 uppercase">Stok</label><input name="stock" type="number" value="${d.stock || ''}" class="input-field"></div>
                    </div>
                    <div><label class="text-[10px] font-bold text-slate-400 uppercase">Rak</label><input name="shelf" value="${d.shelf || ''}" class="input-field"></div>
                    <div class="flex gap-3 pt-2">
                        <button type="button" onclick="closeModal()" class="flex-1 bg-slate-100 text-slate-600 py-3 rounded-xl font-bold">Batal</button>
                        <button class="flex-1 bg-emerald-600 text-white py-3 rounded-xl font-bold shadow-lg">Simpan</button>
                    </div>
                </form>`);
        }
        function handleBookSubmit(e) {
            e.preventDefault();
            const f = e.target;
            const d = {
                id: editId || Date.now(), title: f.title.value, isbn: f.isbn.value,
                author: f.author.value, category: f.category.value,
                stock: parseInt(f.stock.value), shelf: f.shelf.value,
                createdBy: currentUser ? currentUser.id : 'admin'
            };
            if(editId) books = books.map(b => b.id === editId ? d : b);
            else books.push(d);
            saveData(); closeModal();
            showToast('Data buku disimpan!', 'success');
        }

        // PINJAM
        function modalPinjam() {
            const opts = members.filter(m => m.active).map(m => `<option value="${m.id}">${m.name}</option>`).join('');
            const bopts = books.filter(b => b.stock > 0).map(b => `<option value="${b.id}">${b.title}</option>`).join('');
            
            if(!bopts) return showToast("Stok buku habis semua.", 'error');
            if(!opts) return showToast("Tidak ada anggota aktif.", 'error');

            openModal('Transaksi Peminjaman', `
                <form onsubmit="handleLoanSubmit(event)" class="space-y-4">
                    <div class="grid grid-cols-1 gap-3">
                        <div><label class="text-[10px] font-bold text-slate-400 uppercase">Peminjam</label><select name="mid" class="input-field">${opts}</select></div>
                        <div><label class="text-[10px] font-bold text-slate-400 uppercase">Buku</label><select name="bid" class="input-field">${bopts}</select></div>
                    </div>
                    <div class="grid grid-cols-2 gap-3">
                        <div><label class="text-[10px] font-bold text-slate-400 uppercase">Pinjam</label><input name="d" type="date" value="${new Date().toISOString().slice(0, 10)}" class="input-field"></div>
                        <div><label class="text-[10px] font-bold text-slate-400 uppercase">Kembali</label><input name="r" type="date" class="input-field" required></div>
                    </div>
                    <div><label class="text-[10px] font-bold text-slate-400 uppercase">Kondisi</label><select name="cond" class="input-field"><option>Baik</option><option>Rusak</option></select></div>
                    <div class="flex gap-3 pt-2">
                        <button type="button" onclick="closeModal()" class="flex-1 bg-slate-100 text-slate-600 py-3 rounded-xl font-bold">Batal</button>
                        <button class="flex-1 bg-orange-500 text-white py-3 rounded-xl font-bold shadow-lg">Proses</button>
                    </div>
                </form>`);
        }
        function handleLoanSubmit(e) {
            e.preventDefault();
            const f = e.target;
            const m = members.find(x => x.id == f.mid.value);
            const b = books.find(x => x.id == f.bid.value);
            
            if(b.stock <= 0) return showToast("Stok Habis!", 'error');

            b.stock--; 
            loans.push({
                id: Date.now(), memberId: m.id, memberName: m.name,
                bookTitle: b.title, bookId: b.id, status: 'Dipinjam',
                date: f.d.value, returnDate: f.r.value, cond: f.cond.value,
                createdBy: currentUser ? currentUser.id : 'admin'
            });
            saveData(); closeModal();
            showToast('Peminjaman berhasil!', 'success');
        }

        // BUKU TAMU
        function openVisitorForm() {
            openModal('Buku Tamu', `
                <form onsubmit="handleVisitorSubmit(event)" class="space-y-4">
                    <div><label class="text-[10px] font-bold text-slate-400 uppercase">Nama</label><input id="vName" required class="input-field mt-1"></div>
                    <div class="grid grid-cols-2 gap-3">
                        <div><label class="text-[10px] font-bold text-slate-400 uppercase">Pekerjaan</label><input id="vJob" class="input-field mt-1"></div>
                        <div><label class="text-[10px] font-bold text-slate-400 uppercase">HP</label><input id="vPhone" type="number" class="input-field mt-1"></div>
                    </div>
                    <div class="grid grid-cols-2 gap-3">
                        <div><label class="text-[10px] font-bold text-slate-400 uppercase">Asal</label><input id="vOrigin" class="input-field mt-1"></div>
                        <div><label class="text-[10px] font-bold text-slate-400 uppercase">Keperluan</label><select id="vPurpose" class="input-field mt-1"><option>Baca</option><option>Pinjam</option><option>Tugas</option><option>Lainnya</option></select></div>
                    </div>
                    <div><label class="text-[10px] font-bold text-slate-400 uppercase">Alamat</label><textarea id="vAddr" rows="2" class="input-field mt-1"></textarea></div>
                    <div class="flex gap-3 pt-2">
                        <button type="button" onclick="closeModal()" class="flex-1 bg-slate-100 text-slate-600 py-3 rounded-xl font-bold">Batal</button>
                        <button class="flex-1 bg-orange-500 text-white py-3 rounded-xl font-bold shadow-lg">Check In</button>
                    </div>
                </form>`);
        }
        function handleVisitorSubmit(e) {
            e.preventDefault();
            visitors.push({
                date: new Date().toISOString().slice(0, 10),
                name: document.getElementById('vName').value,
                phone: document.getElementById('vPhone').value || '-',
                job: document.getElementById('vJob').value || '-',
                origin: document.getElementById('vOrigin').value || '-',
                purpose: document.getElementById('vPurpose').value,
                address: document.getElementById('vAddr').value || '-'
            });
            saveData(); closeModal(); showToast("Berhasil Check-in!", 'success');
        }

        // --- KATALOG ---
        function openCatalog() { catalogSearch = ''; renderCatalogModal(); }
        function renderCatalogModal() {
            const f = books.filter(b => b.title.toLowerCase().includes(catalogSearch.toLowerCase()) || b.author.toLowerCase().includes(catalogSearch.toLowerCase()));
            const h = `
                <div class="sticky top-0 bg-white pb-2 z-10">
                    <input placeholder="Cari buku..." class="input-field mb-2" oninput="catalogSearch=this.value;renderCatalogModal()" value="${catalogSearch}" autoFocus>
                </div>
                <div class="space-y-2 max-h-[300px] overflow-y-auto custom-scrollbar pr-2">
                    ${f.length ? f.map(b => `
                        <div class="border border-slate-100 p-3 rounded-xl flex justify-between text-sm">
                            <div>
                                <div class="font-bold text-slate-800">${b.title}</div>
                                <div class="text-xs text-slate-500">${b.author || '-'}</div>
                                <div class="text-[10px] text-slate-400 bg-slate-100 px-2 rounded inline-block mt-1">Rak ${b.shelf}</div>
                            </div>
                            <span class="${b.stock > 0 ? 'text-green-600 bg-green-50' : 'text-red-600 bg-red-50'} font-bold px-2 py-1 rounded text-xs h-fit">${b.stock > 0 ? 'Ada' : 'Habis'}</span>
                        </div>`).join('') : '<div class="text-center text-slate-400 mt-4 text-sm">Tidak ditemukan.</div>'}
                </div>
                <button onclick="closeModal()" class="w-full mt-4 bg-slate-100 text-slate-600 py-2 rounded-xl font-bold">Tutup</button>`;
            
            const el = document.getElementById('catalogList');
            if(el && document.getElementById('modalContent').contains(el)) {
                el.innerHTML = h;
                const inp = el.querySelector('input');
                inp.focus(); 
                inp.setSelectionRange(inp.value.length, inp.value.length);
            } else {
                openModal('Katalog Buku', `<div id="catalogList" class="w-full">${h}</div>`);
            }
        }

        // --- LOGIC LAIN ---
        function handlePhoto(i) {
            if(i.files[0]) {
                const r = new FileReader();
                r.onload = e => {
                    photoPreview = e.target.result;
                    const prev = document.getElementById('preview');
                    prev.src = photoPreview;
                    prev.classList.remove('hidden');
                };
                r.readAsDataURL(i.files[0]);
            }
        }
        function kembalikanBuku(id) {
            confirmAction('Buku sudah dikembalikan?', () => {
                const l = loans.find(x => x.id == id);
                l.status = 'Dikembalikan';
                const b = books.find(x => x.id == l.bookId);
                if(b) b.stock++;
                saveData();
                showToast('Buku dikembalikan.', 'success');
            });
        }
        function deleteItem(type, id) {
            const item = (type === 'm' ? members : books).find(i => i.id === id);
            if(!canEdit(item)) return showToast("Akses ditolak. Hanya pembuat data atau admin.", 'error');
            
            confirmAction('Hapus data ini secara permanen?', () => {
                if(type == 'm') members = members.filter(m => m.id !== id);
                else books = books.filter(b => b.id !== id);
                saveData();
                showToast('Data dihapus.', 'info');
            });
        }
        function modalDetail(type, id) {
            const d = (type === 'anggota' ? members.find(x => x.id === id) : type === 'buku' ? books.find(x => x.id === id) : loans.find(x => x.id === id));
            
            // Simple Key-Value Display
            const keys = Object.keys(d).filter(k => k!=='photo' && k!=='createdBy');
            const content = `<div class="space-y-2 text-sm">
                ${d.photo ? `<div class="flex justify-center mb-3"><img src="${d.photo}" class="w-24 h-24 object-cover rounded-full border"></div>` : ''}
                ${keys.map(k => `
                    <div class="flex justify-between border-b border-slate-50 pb-1">
                        <span class="text-slate-400 capitalize text-xs">${k}</span>
                        <span class="font-bold text-slate-700 text-right max-w-[60%] truncate">${d[k]}</span>
                    </div>`).join('')}
                <button onclick="closeModal()" class="w-full mt-4 bg-slate-100 text-slate-600 py-2 rounded-xl font-bold">Tutup</button>
            </div>`;
            openModal('Detail', content);
        }

        // --- PRINTING SYSTEM ---
        function printToArea(html) {
            const a = document.getElementById('printArea');
            a.innerHTML = html;
            setTimeout(() => { window.print(); }, 500); 
        }

        function printCardNew(id) {
            const m = members.find(x => x.id === id);
            printToArea(`
                <div style="width:85.6mm;height:53.98mm;border:1px solid #000;border-radius:8px;overflow:hidden;position:relative;font-family:sans-serif;background:white;-webkit-print-color-adjust:exact;">
                    <div style="background:linear-gradient(135deg,#059669,#047857);height:15mm;display:flex;align-items:center;padding:0 5mm;color:white;">
                        <div style="font-size:20px;margin-right:3mm;">üìö</div>
                        <div>
                            <div style="font-weight:800;font-size:12px;line-height:1;">TBM Anak Bangsa</div>
                            <div style="font-size:8px;opacity:0.9;">Kab. Kepulauan Anambas</div>
                        </div>
                    </div>
                    <div style="padding:4mm;display:flex;gap:4mm;">
                        <div style="width:22mm;height:26mm;background:#f0f0f0;border:1px solid #ddd;overflow:hidden;">
                             ${m.photo ? `<img src="${m.photo}" style="width:100%;height:100%;object-fit:cover;">` : ''}
                        </div>
                        <div style="font-size:10px;line-height:1.4;flex:1;">
                            <div style="font-size:12px;font-weight:bold;color:#333;margin-bottom:2px;text-transform:uppercase;">${m.name}</div>
                            <div style="font-family:monospace;background:#eee;display:inline-block;padding:1px 4px;border-radius:3px;margin-bottom:4px;font-weight:bold;">${m.id}</div>
                            <div style="color:#555;font-size:8px;">${m.address}</div>
                        </div>
                    </div>
                </div>
            `);
        }

        function printDetail(id) {
            const l = loans.find(x => x.id === id);
            printToArea(`
                <div style="width:76mm;padding:5px;font-family:'Courier New', monospace;font-size:12px;">
                    <center><b>TBM Anak Bangsa</b><br>Anambas<br>----------------</center>
                    <br>
                    Tgl: ${l.date}<br>
                    Nama: ${l.memberName}<br>
                    Buku: ${l.bookTitle}<br>
                    Status: ${l.status}<br>
                    <br>
                    <center>Kembali: ${l.returnDate}</center>
                </div>
            `);
        }

        function printRecapNew(type, s, e) {
            let t = '', h = '', r = '', l = [];
            const now = new Date().toLocaleDateString('id-ID');

            if (type === 'visitor') {
                l = visitors; if (s && e) l = l.filter(i => i.date >= s && i.date <= e);
                t = 'LAPORAN PENGUNJUNG';
                h = '<th>No</th><th>Tanggal</th><th>Nama</th><th>Pekerjaan</th><th>Keperluan</th>';
                r = l.map((v, i) => `<tr><td align="center">${i + 1}</td><td>${v.date}</td><td>${v.name}</td><td>${v.job || '-'}</td><td>${v.purpose}</td></tr>`).join('');
            } else if (type === 'peminjaman') {
                l = loans; if (s && e) l = l.filter(i => i.date >= s && i.date <= e);
                t = 'LAPORAN SIRKULASI';
                h = '<th>No</th><th>Tgl</th><th>Kembali</th><th>Nama</th><th>Buku</th><th>Status</th>';
                r = l.map((x, i) => `<tr><td align="center">${i + 1}</td><td>${x.date}</td><td>${x.returnDate}</td><td>${x.memberName}</td><td>${x.bookTitle}</td><td align="center">${x.status}</td></tr>`).join('');
            } else if (type === 'anggota') {
                l = members;
                t = 'DATA ANGGOTA';
                h = '<th>No</th><th>ID</th><th>Nama</th><th>TTL</th><th>Alamat</th>';
                r = l.map((m, i) => `<tr><td align="center">${i + 1}</td><td>${m.id}</td><td>${m.name}</td><td>${m.birthPlace}, ${m.birthDate}</td><td>${m.address}</td></tr>`).join('');
            } else if (type === 'buku') {
                l = books;
                t = 'STOK BUKU';
                h = '<th>No</th><th>ISBN</th><th>Judul</th><th>Penulis</th><th>Rak</th><th>Stok</th>';
                r = l.map((b, i) => `<tr><td align="center">${i + 1}</td><td>${b.isbn||'-'}</td><td>${b.title}</td><td>${b.author||'-'}</td><td align="center">${b.shelf}</td><td align="center">${b.stock}</td></tr>`).join('');
            }

            printToArea(`
                <div style="font-family:sans-serif; padding:20px;">
                    <h3 style="text-align:center;margin-bottom:5px;">TBM Anak Bangsa</h3>
                    <p style="text-align:center;margin-top:0;font-size:12px;">Kabupaten Kepulauan Anambas</p>
                    <h4 style="text-align:center;text-decoration:underline;margin:20px 0;">${t}</h4>
                    ${s ? `<p style="text-align:center;font-size:11px;">Periode: ${s} s/d ${e}</p>` : ''}
                    <table border="1" cellspacing="0" cellpadding="5" style="width:100%;border-collapse:collapse;font-size:11px;">
                        <thead><tr style="background:#eee;">${h}</tr></thead>
                        <tbody>${r}</tbody>
                    </table>
                    <div style="margin-top:30px;text-align:right;font-size:11px;">
                        <p>Anambas, ${now}<br><br><br>( Pengelola )</p>
                    </div>
                </div>
            `);
        }

        function printRecapSirkulasiCustom(type) {
            const s = document.getElementById('repStart').value;
            const e = document.getElementById('repEnd').value;
            if (!s || !e) return showToast("Pilih tanggal Dari dan Sampai dulu.", 'error');
            printRecapNew(type, s, e);
        }

        // INIT APP
        render();
    </script>
</body>
</html>


